<!DOCTYPE html>
<html lang="pt-br" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema Optométrico Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { medical: '#0ea5e9', cyber: '#22d3ee', darkBg: '#020617', surface: '#0f172a' }, fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] } } }
        }
    </script>
    <style>
        :root { color-scheme: dark; }
        body { overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .dark .glass-card { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255, 255, 255, 0.05); }
        .btn-medical { background: linear-gradient(135deg, #0ea5e9 0%, #22d3ee 100%); transition: all 0.3s; color: #fff; font-weight: 700; min-height: 44px; }
        .input-clinical { background: #1e293b; border: 1px solid rgba(255, 255, 255, 0.1); color: white; border-radius: 10px; padding: 0.75rem; width: 100%; outline: none; min-height: 44px; }
        .input-clinical:disabled { opacity: 0.6; cursor: not-allowed; background: #0f172a; border-color: transparent; }
        .status-pill { padding: 6px 10px; border-radius: 6px; font-size: 10px; font-weight: 800; text-transform: uppercase; border: none; cursor: pointer; color: white; min-height: 32px; }
        .st-agendado { background: #475569; } .st-recepcao { background: #ca8a04; } .st-consulta { background: #7c3aed; } .st-finalizado { background: #16a34a; }
        .filter-btn { transition: all 0.3s; border: 1px solid rgba(255,255,255,0.05); color: #94a3b8; font-size: 10px; font-weight: bold; padding: 10px 16px; border-radius: 8px; text-transform: uppercase; cursor: pointer; min-height: 44px; }
        .filter-btn.active { background-color: #0ea5e9; color: white; border-color: #0ea5e9; box-shadow: 0 0 15px rgba(14, 165, 233, 0.3); }
        .rx-table th { background: rgba(14, 165, 233, 0.2); font-size: 10px; padding: 8px 5px; border: 1px solid rgba(255,255,255,0.1); color: #22d3ee; }
        .rx-table td { border: 1px solid rgba(255,255,255,0.1); }
        .rx-table input { background: transparent; border: none; width: 100%; text-align: center; padding: 10px 5px; color: white; outline: none; min-height: 44px; }
        select option { background-color: #0f172a !important; color: white !important; }
        .nav-item.active { background: rgba(14, 165, 233, 0.1); color: #0ea5e9; border-right: 3px solid #0ea5e9; border-radius: 0; }
        .tab-btn.active { border-bottom: 2px solid #0ea5e9; color: #0ea5e9; }
        
        #sidebar { transition: transform 0.3s ease-in-out; }
        @media (max-width: 1024px) {
            #sidebar { transform: translateX(-100%); }
            #sidebar.open { transform: translateX(0); }
        }

        .auth-screen { background: radial-gradient(circle at top right, #0f172a, #020617); }
        .animate-pulse-slow { animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in-up { animation: fadeIn 0.6s ease-out forwards; }

        .lente-opt { cursor: pointer; transition: all 0.2s; border: 1px solid rgba(255,255,255,0.1); }
        .lente-opt.selected { background: #0ea5e9; border-color: #22d3ee; color: white; }
        .lente-opt .order-badge { display: none; background: rgba(0,0,0,0.3); width: 18px; height: 18px; border-radius: 50%; font-size: 10px; align-items: center; justify-content: center; }
        .lente-opt.selected .order-badge { display: flex; }

        @keyframes blink-red {
            0%, 100% { color: #fff; }
            50% { color: #ef4444; }
        }
        .bday-today { animation: blink-red 0.8s infinite; font-weight: 800; color: #ef4444 !important; }
        
        .logo-preview { width: 120px; height: 120px; border-radius: 20px; object-fit: contain; background: #020617; border: 2px dashed rgba(255,255,255,0.1); }




/* --- GESTÃO DE ACESSOS: SWITCHES --- */
.switch { position: relative; display: inline-block; width: 44px; height: 22px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: #0ea5e9; }
input:checked + .slider:before { transform: translateX(22px); }






    </style>
</head>
<body class="bg-slate-50 dark:bg-darkBg text-slate-800 dark:text-slate-200 min-h-screen">

    <!-- TELA DE LOGIN -->
    <div id="auth-container" class="fixed inset-0 z-[500] auth-screen flex items-center justify-center p-4">
        <div class="glass-card p-8 md:p-10 rounded-[2.5rem] w-full max-w-[400px] shadow-2xl border border-white/10 fade-in-up">
            <div class="text-center mb-10">
                <img id="img-login-logo" src="Logo Girlanildo Branco.png" alt="Logo" class="h-24 mx-auto mb-6 animate-pulse-slow">
                <h2 id="auth-title" class="text-3xl font-black italic uppercase text-white tracking-tighter">Login <span class="text-medical">USUARIO</span></h2>
                <p id="auth-subtitle" class="text-slate-500 text-[10px] uppercase font-bold tracking-[0.2em] mt-2">Plataforma Optométrica Pro</p>
            </div>

            <div class="space-y-4">
                <div class="group">
                    <label class="text-[9px] uppercase font-bold text-cyber ml-2 opacity-70 group-focus-within:opacity-100 transition-all">E-mail de Acesso</label>
                    <input type="email" id="auth-email" autocomplete="off" class="input-clinical border-white/5 focus:border-medical transition-all" placeholder="clinica@nexgen.com">
                </div>
                <div class="group">
                    <label class="text-[9px] uppercase font-bold text-cyber ml-2 opacity-70 group-focus-within:opacity-100 transition-all">Chave de Segurança</label>
                    <input type="password" id="auth-password" autocomplete="new-password" class="input-clinical border-white/5 focus:border-medical transition-all" placeholder="••••••••">
                </div>

                <button id="btn-auth-main" onclick="window.handleAuth()" class="btn-medical w-full py-4 rounded-2xl shadow-lg shadow-medical/20 hover:scale-[1.02] active:scale-95 transition-all mt-6">
                    ACESSAR SISTEMA
                </button>

                <div class="pt-6 mt-3 border-t border-white/5">
                    <button onclick="window.showDevInfo()" class="flex items-center justify-center gap-2 mx-auto text-slate-500 hover:text-medical transition-colors">
                        <i data-lucide="info" class="w-4 h-4"></i>
                        <span class="text-[9px] font-bold uppercase tracking-widest">Suporte e Desenvolvedor</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTEÚDO DO SISTEMA -->
    <div id="main-app" class="hidden">
        <header class="lg:hidden fixed top-0 left-0 right-0 h-16 glass z-[60] flex items-center px-4 justify-between">
            <img id="img-header-mobile-logo" src="Logo Girlanildo Branco.png" alt="Logo" class="h-8 object-contain">
            <button onclick="toggleSidebar()" class="p-2 text-white bg-medical rounded-lg">
                <i data-lucide="menu"></i>
            </button>
        </header>

        <aside id="sidebar" class="fixed left-0 top-0 h-full w-64 glass border-r border-white/5 z-[70] flex flex-col">
            <div class="p-8 hidden lg:flex items-center gap-4">
                <img id="img-sidebar-logo" src="Logo Girlanildo Branco.png" alt="Logo" class="w-full h-auto object-contain max-h-24">
            </div>
            <nav class="flex-1 space-y-1 mt-20 lg:mt-0" id="sidebar-nav">
                <button onclick="nav('agenda')" class="nav-item active w-full flex items-center gap-4 p-4 hover:bg-white/5 transition-all"><i data-lucide="calendar"></i> <span class="font-semibold">Agenda</span></button>
                <button onclick="nav('pacientes-db')" class="nav-item w-full flex items-center gap-4 p-4 hover:bg-white/5 transition-all"><i data-lucide="users"></i> <span class="font-semibold">Pacientes</span></button>
                <button onclick="nav('oticas')" class="nav-item w-full flex items-center gap-4 p-4 hover:bg-white/5 transition-all"><i data-lucide="store"></i> <span class="font-semibold">Óticas Parceiras</span></button>
                <button onclick="nav('templates')" class="nav-item w-full flex items-center gap-4 p-4 hover:bg-white/5 transition-all"><i data-lucide="message-square"></i> <span class="font-semibold">Mensagens</span></button>
                <button onclick="nav('financeiro')" class="nav-item w-full flex items-center gap-4 p-4 hover:bg-white/5 transition-all"><i data-lucide="bar-chart-3"></i> <span class="font-semibold">Relatório</span></button>
                <button onclick="nav('configuracoes')" class="nav-item w-full flex items-center gap-4 p-4 hover:bg-white/5 transition-all"><i data-lucide="settings"></i> <span class="font-semibold">Configurações</span></button>
                
                <button onclick="window.handleLogout()" class="w-full flex items-center gap-4 p-4 hover:bg-red-500/10 text-red-500 transition-all mt-auto border-t border-white/5">
                    <i data-lucide="log-out"></i> <span class="font-semibold uppercase text-xs">Sair da Conta</span>
                </button>
            </nav>
            <div onclick="toggleSidebar()" class="lg:hidden absolute top-4 right-4 text-white p-2">
                <i data-lucide="x"></i>
            </div>
        </aside>

        <main class="lg:ml-64 p-4 md:p-8 lg:p-12 pt-24 lg:pt-12">
            
            <!-- SECÇÃO AGENDA -->
            <div id="sec-agenda" class="content-sec">
                <div class="flex flex-col md:flex-row justify-between items-start gap-6 mb-10">
                    <div>
                        <h1 class="text-3xl md:text-4xl font-bold uppercase italic text-white">Agenda <span class="text-medical">Optométrica</span></h1>
                        <p id="display-date" class="text-slate-500 font-mono mt-2 uppercase text-[15px] tracking-widest"></p>
                    </div>
                    <div class="flex flex-col items-start md:items-end w-full md:w-auto">
                        <div class="flex gap-2 w-full md:w-auto">
                            <button onclick="window.imprimirLista()" title="Imprimir Relatório Filtrado" class="bg-white/5 hover:bg-medical/20 border border-white/10 p-3 rounded-xl text-cyber transition-all">
                                <i data-lucide="printer"></i>
                            </button>
                            <button onclick="window.openModalCadastro('paciente')" class="btn-medical flex-1 md:flex-none px-6 py-3 rounded-xl flex items-center justify-center gap-2 text-white">
                                <i data-lucide="plus"></i> NOVO AGENDAMENTO
                            </button>
                        </div>
                        <div class="mt-4 text-left md:text-right">
                            <span class="text-[10px] uppercase font-bold text-slate-500 tracking-widest block">Atendidos no período</span>
                            <span id="resumo-atendidos-agenda" class="text-3xl font-black text-medical italic leading-none">0</span>
                        </div>
                    </div>
                </div>

                <!-- BARRA DE PESQUISA E SELETORES -->
                <div class="flex flex-wrap items-center gap-3 mb-8">
                    <div class="flex flex-1 min-w-[300px] gap-2">
                        <input type="text" id="search-agenda" oninput="window.filtrarBuscaAgenda(this.value)" placeholder="Buscar na agenda por nome ou CPF..." class="bg-surface border border-white/10 p-3 rounded-xl outline-none flex-1 min-h-[44px] text-white">
                        <button onclick="window.limparBuscaAgenda()" class="bg-white/5 px-6 py-3 rounded-xl font-bold uppercase text-[10px] min-h-[44px] text-white">Limpar</button>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="month" id="filtro-mes-agenda" onchange="window.filtrarPorMesAgenda(this.value)" class="bg-white/5 border border-white/10 px-4 py-2 rounded-lg text-xs uppercase outline-none text-white min-h-[44px]">
                        <button onclick="window.limparFiltros()" class="text-red-500 text-[10px] font-bold uppercase py-2 hover:bg-red-500/10 px-4 rounded-lg transition-all">Limpar Tudo</button>
                    </div>
                </div>

                <!-- FILTROS DE STATUS E ÓTICA -->
                <div class="flex flex-wrap gap-2 mb-8 items-center">
                    <button onclick="window.filtrarStatus('Todos')" class="filter-btn active" id="btn-Todos">Todos</button>
                    <div class="flex items-center gap-2">
                        <button onclick="window.filtrarStatus('Agendado')" class="filter-btn bg-white/5" id="btn-Agendado">Agendados</button>
                        <input type="date" id="cal-agendado" onchange="window.selecionarDataAgendado(this.value)" class="hidden bg-white/5 border border-white/10 px-3 py-1.5 rounded-lg text-xs outline-none text-white min-h-[44px]">
                    </div>
                    <button onclick="window.filtrarStatus('Recepção')" class="filter-btn bg-white/5" id="btn-Recepção">Recepção</button>
                    <button onclick="window.filtrarStatus('Consulta')" class="filter-btn bg-white/5" id="btn-Consulta">Consulta</button>
                    <button onclick="window.filtrarStatus('Finalizado')" class="filter-btn bg-white/5" id="btn-Finalizado">Finalizados</button>
                    
                    <div class="flex flex-1 flex-wrap gap-2 min-w-full md:min-w-0 mt-2 md:mt-0">
                        <select id="filtro-otica-agenda" onchange="window.filtrarPorOtica(this.value)" class="bg-white/5 border border-white/10 px-4 py-2 rounded-lg text-xs uppercase outline-none text-white flex-1 md:w-40 min-h-[44px]"></select>
                        <!-- NOVO FILTRO DE PAGAMENTO -->
                        <select id="filtro-pago-agenda" onchange="window.filtrarPorPagamento(this.value)" class="bg-white/5 border border-white/10 px-4 py-2 rounded-lg text-xs uppercase outline-none text-white flex-1 md:w-40 min-h-[44px]">
                            <option value="Todos">Pagamento (Todos)</option>
                            <option value="Pago">Pago</option>
                            <option value="Pendente">Pendente</option>
                        </select>
                    </div>
                </div>

                <div class="glass-card rounded-[1.5rem] md:rounded-[2rem] overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left min-w-[700px]">
                            <thead class="bg-white/5 text-[10px] uppercase tracking-widest opacity-50">
                                <tr><th class="py-4 px-6 text-white">Data/Hora</th><th class="py-4 px-6 text-white">Paciente</th><th class="py-4 px-6 text-white">Ótica</th><th class="py-4 px-6 text-white">Status</th><th class="py-4 px-6 text-center text-white">Pago</th><th class="py-4 px-6 text-right text-white">Ações</th></tr>
                            </thead>
                            <tbody id="lista-agenda" class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- PACIENTES -->
            <div id="sec-pacientes-db" class="hidden content-sec">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 mb-10">
                    <h1 class="text-3xl md:text-4xl font-bold uppercase italic text-white">Pacientes</h1>
                    <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                        <input type="text" id="search-paciente" oninput="window.filtrarBuscaPaciente(this.value)" placeholder="Buscar por nome..." class="bg-surface border border-white/10 p-3 rounded-xl outline-none flex-1 md:w-64 min-h-[44px] text-white">
                        <button onclick="window.limparBuscaPaciente()" class="bg-white/5 px-6 py-3 rounded-xl font-bold uppercase text-[10px] min-h-[44px] text-white">Limpar</button>
                    </div>
                </div>
                <div class="glass-card rounded-[1.5rem] md:rounded-[2rem] overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left min-w-[600px]">
                            <thead class="bg-white/5 text-[9px] uppercase tracking-widest opacity-50">
                                <tr><th class="py-4 px-6 text-white">Nome</th><th class="py-4 px-6 text-white">Idade / Aniversário</th><th class="py-4 px-6 text-white">WhatsApp</th><th class="py-4 px-6 text-white">Data do Exame</th><th class="py-4 px-6 text-right text-white">Ações</th></tr>
                            </thead>
                            <tbody id="lista-db-pacientes" class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- FINANCEIRO -->
            <div id="sec-financeiro" class="hidden content-sec">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 mb-10">
                    <h2 class="text-3xl md:text-4xl font-bold text-white uppercase italic">Financeiro</h2>
                    <input type="month" id="filtro-mes" onchange="window.calcularFinanceiro()" class="input-clinical !w-full md:!w-auto">
                </div>
                <div id="resumo-cards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 md:gap-6 mb-8 text-center text-white font-bold">
                    <div class="glass-card p-6 rounded-2xl border-b-4 border-green-500">
                        <p class="text-[10px] uppercase opacity-50">Global</p>
                        <h3 class="text-2xl md:text-3xl" id="total-global">R$ 0,00</h3>
                    </div>
                    <div class="glass-card p-6 rounded-2xl border-b-4 border-medical">
                        <p class="text-[10px] uppercase opacity-50">Atendidos</p>
                        <h3 class="text-2xl md:text-3xl" id="prod-total">0</h3>
                    </div>

                </div>
                <div id="financeiro-resumo" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
            </div>

            <div id="sec-oticas" class="hidden content-sec">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-8 text-white">
                    <h2 class="text-3xl font-bold italic uppercase">Óticas</h2>
                    <button onclick="window.openModalCadastro('otica')" class="btn-medical w-full sm:w-auto px-6 py-2 rounded-xl">Nova Ótica</button>
                </div>
                <div id="grid-oticas" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="sec-templates" class="hidden content-sec">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-8 text-white">
                    <h2 class="text-3xl font-bold italic uppercase">MENSAGENS</h2>
                    <button onclick="window.openModalCadastro('template')" class="btn-medical w-full sm:w-auto px-6 py-2 rounded-xl">Novo Modelo</button>
                </div>
                <div id="grid-templates" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <!-- CONFIGURAÇÕES -->
            <div id="sec-configuracoes" class="hidden content-sec">
                <div class="mb-10">
                    <h1 class="text-3xl md:text-4xl font-bold uppercase italic text-white">Configurações</h1>
                    <div class="flex gap-4 mt-8 border-b border-white/10 overflow-x-auto pb-2">
                        <button onclick="window.switchConfigTab('clinica')" id="tab-config-clinica" class="tab-btn active whitespace-nowrap text-[10px] font-bold uppercase tracking-wider">Clínica</button>
                        <button onclick="window.switchConfigTab('usuario')" id="tab-config-usuario" class="tab-btn whitespace-nowrap text-[10px] font-bold uppercase tracking-wider">Usuário</button>
                        <button onclick="window.switchConfigTab('sistema')" id="tab-config-sistema" class="tab-btn whitespace-nowrap text-[10px] font-bold uppercase tracking-wider">Sistema</button>
                    </div>
                </div>
                
                <!-- ABA CLÍNICA (ATUALIZADA COM BLOQUEIO DE EDIÇÃO) -->
                <div id="aba-config-clinica" class="config-pane">
                    <div class="glass-card p-6 md:p-8 rounded-3xl">
                        <div class="flex flex-col lg:flex-row gap-8">
                            <div class="flex flex-col items-center gap-4">
                                <label class="text-[10px] uppercase font-bold text-cyber opacity-70">Logo da Clínica</label>
                                <img id="conf-logo-preview" src="Logo Girlanildo Branco.png" class="logo-preview">
                                <input type="file" id="conf-logo-input" accept="image/*" class="hidden" onchange="window.previewAndStoreLogo(this)">
                                <button id="btn-choice-logo" onclick="document.getElementById('conf-logo-input').click()" class="bg-white/5 hover:bg-white/10 px-4 py-2 rounded-xl text-[10px] font-bold uppercase border border-white/10 w-full">Escolher Arquivo</button>
                                <input type="hidden" id="conf-logo-base64">
                            </div>
                            <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2"><label class="text-[9px] uppercase font-bold opacity-40">Nome da Clínica</label><input type="text" id="conf-clinica-nome" class="input-clinical"></div>
                                <div class="md:col-span-2"><label class="text-[9px] uppercase font-bold opacity-40">Slogan / Frase de Impacto</label><input type="text" id="conf-clinica-slogan" class="input-clinical"></div>
                                <div><label class="text-[9px] uppercase font-bold opacity-40">CNPJ</label><input type="text" id="conf-clinica-cnpj" class="input-clinical"></div>
                                <div><label class="text-[9px] uppercase font-bold opacity-40">Telefones (WhatsApp)</label><input type="text" id="conf-clinica-tel" class="input-clinical"></div>
                                <div class="md:col-span-2"><label class="text-[9px] uppercase font-bold opacity-40">Endereço Completo</label><input type="text" id="conf-clinica-endereco" class="input-clinical"></div>
                                <div><label class="text-[9px] uppercase font-bold opacity-40">Cidade - UF</label><input type="text" id="conf-clinica-cidade" class="input-clinical"></div>
                                <div><label class="text-[9px] uppercase font-bold opacity-40">CEP</label><input type="text" id="conf-clinica-cep" class="input-clinical"></div>
                                <div><label class="text-[9px] uppercase font-bold opacity-40">Email de Contato</label><input type="email" id="conf-clinica-email" class="input-clinical"></div>
                                <div><label class="text-[9px] uppercase font-bold opacity-40">Responsável Técnico</label><input type="text" id="conf-clinica-resp" class="input-clinical"></div>
                                <div><label class="text-[9px] uppercase font-bold opacity-40">CBOO / Registro Profissional</label><input type="text" id="conf-clinica-registro" class="input-clinical"></div>
                            </div>
                        </div>
                        <div class="mt-8 pt-8 border-t border-white/5 flex flex-col sm:flex-row justify-end gap-4">
                            <button id="btn-edit-clinic" onclick="window.enableClinicEdit()" class="bg-cyber/20 text-cyber px-8 py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-cyber hover:text-darkBg transition-all">Editar Dados</button>
                            <button id="btn-save-clinic" onclick="window.saveClinicData()" class="btn-medical px-12 py-4 rounded-2xl shadow-lg shadow-medical/20 font-black uppercase tracking-widest hover:scale-105 active:scale-95 transition-all hidden">Salvar Configurações</button>
                        </div>
                    </div>
                </div>





               <!-- ABA USUÁRIO (ONDE O BOTÃO VAI FICAR) -->
<div id="aba-config-usuario" class="config-pane hidden">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        
        <!-- BOTÃO DE GESTÃO DE ACESSOS -->
        <button id="btn-config-acessos" onclick="window.acessarPainelRestricoes()" class="glass-card p-8 rounded-[2.5rem] flex flex-col items-center gap-4 hover:border-cyber/40 transition-all group">
            <div class="w-16 h-16 bg-cyber/10 rounded-2xl flex items-center justify-center text-cyber group-hover:scale-110 transition-transform">
                <i data-lucide="shield-alert" class="w-8 h-8"></i>
            </div>
            <span class="font-bold uppercase italic text-white tracking-tighter text-xl">Gestão de Acessos</span>
            <p class="text-[9px] text-slate-500 uppercase font-bold tracking-widest">Gerenciar contas e permissões</p>
        </button>

        <!-- Você pode adicionar outros botões aqui no futuro, como "Alterar Minha Senha" -->
        
    </div>
</div>







                <div id="aba-config-sistema" class="config-pane hidden">
                    <div class="glass-card p-8 rounded-3xl"><p class="text-slate-400 italic">Configurações do Sistema em desenvolvimento...</p></div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAIS -->
    <div id="modal-paciente" class="fixed inset-0 bg-black/95 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-2 md:p-4">
        <div class="glass-card bg-surface p-4 md:p-8 rounded-[1.5rem] md:rounded-[2rem] w-full max-w-5xl shadow-2xl max-h-[95vh] overflow-y-auto text-white">
            <div class="flex flex-col md:flex-row justify-between items-start gap-4 mb-6">
                <div class="w-full">
                    <h3 class="text-xl md:text-2xl font-bold italic text-medical" id="title-paciente">Ficha do Paciente</h3>
                    <div class="flex gap-4 mt-4 overflow-x-auto pb-2">
                        <button onclick="window.switchTab('cadastro')" id="tab-btn-cadastro" class="tab-btn active whitespace-nowrap text-[10px] font-bold uppercase tracking-wider">Dados Gerais</button>
                        <button onclick="window.switchTab('historico')" id="tab-btn-historico" class="tab-btn whitespace-nowrap text-[10px] font-bold uppercase tracking-wider">Histórico de Exames</button>
                    </div>
                </div>
                <button onclick="window.openExame()" id="btn-cadastrar-prontuario" class="w-full md:w-auto bg-cyber/20 text-cyber px-4 py-3 rounded-xl font-bold text-[10px] uppercase hover:bg-cyber transition-all"><span>Cadastrar Novo Prontuário</span></button>
            </div>
            
            <div id="aba-cadastro" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                <div class="sm:col-span-2"><label class="text-[9px] uppercase font-bold opacity-40">Nome Completo</label><input type="text" id="p-nome" oninput="window.autoFillPaciente(this.value)" class="input-clinical"></div>
                <div><label class="text-[9px] uppercase font-bold opacity-40">Sexo</label><select id="p-sexo" class="input-clinical"><option value="M">Masculino</option><option value="F">Feminino</option></select></div>
                <div><label class="text-[9px] uppercase font-bold opacity-40">Data Nascimento</label><input type="date" id="p-nascimento" onchange="window.updateAge(this.value)" class="input-clinical"></div>
                <div><label class="text-[9px] uppercase font-bold opacity-40">Idade Calculada</label><input type="text" id="p-idade-calc" readonly class="input-clinical border-none bg-white/5"></div>
                <div><label class="text-[9px] uppercase font-bold text-cyber">CPF</label><input type="text" id="p-cpf" placeholder="000.000.000-00" maxlength="14" oninput="window.mascaraCPF(this)" class="input-clinical"></div>
                <div><label class="text-[9px] uppercase font-bold opacity-40">WhatsApp</label><input type="text" id="p-tel" oninput="window.mascaraTelefone(this)" maxlength="15" placeholder="(00) 00000-0000" class="input-clinical"></div>
                <div><label class="text-[9px] uppercase font-bold opacity-40">Origem</label><input type="text" id="p-origem" class="input-clinical"></div>
                <div><label class="text-[9px] uppercase font-bold opacity-40">Propissão</label><input type="text" id="p-profissao" class="input-clinical"></div>
                <div><label class="text-[9px] uppercase font-bold opacity-40">Passatempo</label><input type="text" id="p-passatempo" class="input-clinical"></div>
                <div class="sm:col-span-2"><label class="text-[9px] uppercase font-bold opacity-40">Endereço</label><input type="text" id="p-endereco" class="input-clinical"></div>
                <div><label class="text-[9px] uppercase font-bold opacity-40">Último Exame</label><input type="date" id="p-ultimo-exame" class="input-clinical"></div>
                <div class="sm:col-span-2"><label class="text-[9px] uppercase font-bold opacity-40">Ajuda Óptica Prescrita</label><input type="text" id="p-ajuda" class="input-clinical"></div>
                <div><label class="text-[9px] uppercase font-bold opacity-40">Responsável</label><input type="text" id="p-responsavel" class="input-clinical"></div>
                <div><label class="text-[9px] uppercase font-bold text-medical">Data Agenda</label><input type="date" id="p-data-agenda" class="input-clinical border-medical/40"></div>
                <div><label class="text-[9px] uppercase font-bold text-medical">Hora</label><input type="time" id="p-hora" class="input-clinical border-medical/40"></div>
                <div class="sm:col-span-3 grid grid-cols-1 sm:grid-cols-3 gap-4 mt-2">
                    <div><label class="text-[9px] uppercase font-bold opacity-40">Ótica</label><select id="p-otica" class="input-clinical"></select></div>
                    <div><label class="text-[9px] uppercase font-bold opacity-40">Status</label><select id="p-status-modal" class="input-clinical"><option value="Agendado">Agendado</option><option value="Recepção" selected>Recepção</option><option value="Consulta">Consulta</option><option value="Finalizado">Finalizado</option></select></div>
                    <div><label class="text-[9px] uppercase font-bold opacity-40">Pagamento</label><select id="p-pago-modal" class="input-clinical"><option value="Pendente">Pendente</option><option value="Pago">Pago</option></select></div>
                </div>
            </div>

            <div id="aba-historico" class="hidden space-y-6">
                <div id="historico-render" class="grid grid-cols-1 gap-6"></div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 mt-8">
                <button id="btn-salvar-paciente" onclick="window.savePatient()" class="flex-1 btn-medical py-4 rounded-xl uppercase font-bold text-white order-2 sm:order-1">Salvar Registro</button>
                <button id="btn-habilitar-edicao" onclick="window.enablePatientEdit()" class="flex-1 hidden bg-cyber py-4 rounded-xl uppercase font-bold text-darkBg order-2 sm:order-1">Habilitar Edição</button>
                <button onclick="window.closeModal('modal-paciente')" class="w-full sm:w-32 bg-white/5 py-4 rounded-xl uppercase text-[10px] font-bold text-white order-1 sm:order-2">Fechar</button>
            </div>
        </div>
    </div>

    <div id="modal-exame" class="fixed inset-0 bg-black/98 backdrop-blur-md hidden  z-[110] flex items-center justify-center p-2 md:p-4">
        <div class="glass-card bg-surface p-4 md:p-10 rounded-[1.5rem] md:rounded-[2rem] w-full max-w-4xl shadow-2xl max-h-[90vh] overflow-y-auto text-white">
            <h3 class="text-2xl md:text-3xl font-bold italic text-medical mb-8 uppercase tracking-tighter" id="title-modal-exame">Novo Exame Clínico</h3>
            
            <div class="space-y-10">
                <div>
                    <h4 class="text-medical font-bold text-lg mb-4 uppercase flex items-center gap-2"><i data-lucide="eye"></i> 15. RX FINAL</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full rx-table text-center text-white min-w-[500px]">
                            <thead><tr><th class="w-16"></th><th>ESF.</th><th>CIL.</th><th>EIXO.</th><th>AV LONGE</th><th>AV PERTO</th></tr></thead>
                            <tbody>
                                <tr><th class="bg-white/5">OD</th><td><input type="text" id="rx-od-esf" onblur="window.formatLens(this)"></td><td><input type="text" id="rx-od-cil" onblur="window.formatLens(this)"></td><td><input type="text" id="rx-od-eixo" onblur="window.formatDegree(this)"></td><td><input type="text" id="rx-od-av" onblur="window.formatAV(this)"></td><td><input type="text" id="rx-od-av-perto" onblur="window.formatAVPerto(this)"></td></tr>
                                <tr><th class="bg-white/5">OE</th><td><input type="text" id="rx-oe-esf" onblur="window.formatLens(this)"></td><td><input type="text" id="rx-oe-cil" onblur="window.formatLens(this)"></td><td><input type="text" id="rx-oe-eixo" onblur="window.formatDegree(this)"></td><td><input type="text" id="rx-oe-av" onblur="window.formatAV(this)"></td><td><input type="text" id="rx-oe-av-perto" onblur="window.formatAVPerto(this)"></td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                        <div class="flex items-center gap-2 bg-white/5 p-3 rounded-xl text-[10px]"><b>ADD:</b> <input type="text" id="rx-add" onblur="window.formatADD(this)" class="bg-transparent outline-none w-full"></div>
                        <div class="flex items-center gap-2 bg-white/5 p-3 rounded-xl text-[10px]"><b>DP:</b> <input type="text" id="rx-dp" class="bg-transparent outline-none w-full"></div>
                    </div>
                </div>
                
                <div>
                    <h4 class="text-medical font-bold text-lg mb-4 uppercase flex items-center gap-2"><i data-lucide="activity"></i> 7. OFTALMOSCOPIA</h4>
                    <div class="flex items-center gap-2 bg-white/5 p-3 rounded-xl mb-4 text-[10px] font-bold text-white">BRUCKNER: <input type="text" id="oft-bruckner" class="bg-transparent outline-none w-full"></div>
                    <div class="overflow-x-auto">
                        <table class="w-full rx-table text-[10px] text-white min-w-[500px]">
                            <thead><tr><th>Aspecto</th><th>Olho Direito</th><th>Olho Esquerdo</th></tr></thead>
                            <tbody class="text-center">
                                <tr><th class="bg-white/5">Papila</th><td><input type="text" id="oft-od-papila"></td><td><input type="text" id="oft-oe-papila"></td></tr>
                                <tr><th class="bg-white/5">Escavação</th><td><input type="text" id="oft-od-escav"></td><td><input type="text" id="oft-oe-escav"></td></tr>
                                <tr><th class="bg-white/5">Mácula</th><td><input type="text" id="oft-od-macula"></td><td><input type="text" id="oft-oe-macula"></td></tr>
                                <tr><th class="bg-white/5">Fixação</th><td><input type="text" id="oft-od-fixacao"></td><td><input type="text" id="oft-oe-fixacao"></td></tr>
                                <tr><th class="bg-white/5">Relação A/V</th><td><input type="text" id="oft-od-relacao-av"></td><td><input type="text" id="oft-oe-relacao-av"></td></tr>
                                <tr><th class="bg-white/5">Cor</th><td><input type="text" id="oft-od-cor"></td><td><input type="text" id="oft-oe-cor"></td></tr>
                                <tr><th class="bg-white/5">Lente</th><td><input type="text" id="oft-od-lente"></td><td><input type="text" id="oft-oe-lente"></td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4"><b class="text-[10px] uppercase opacity-50">Observações:</b><textarea id="oft-obs" class="input-clinical mt-2 h-24"></textarea></div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 mt-10">
                <button id="btn-salvar-exame" onclick="window.saveExame()" class="flex-1 btn-medical py-4 rounded-2xl font-bold uppercase">Salvar Prontuário</button>
                <button onclick="window.closeModal('modal-exame')" class="w-full sm:w-32 bg-white/5 py-4 rounded-2xl font-bold uppercase text-[10px]">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE SELEÇÃO DE LENTES -->
    <div id="modal-lentes" class="fixed inset-0 bg-black/90 backdrop-blur-md hidden z-[200] flex items-center justify-center p-4">
        <div class="glass-card bg-surface p-6 md:p-8 rounded-[2rem] w-full max-w-lg shadow-2xl text-white">
            <h3 class="text-2xl font-bold mb-2 italic text-medical uppercase">Opções da Receita</h3>
            <p class="text-[10px] text-slate-400 uppercase font-bold tracking-widest mb-6">Selecione as lentes na ordem desejada</p>
            
            <div id="lentes-grid" class="grid grid-cols-2 gap-3 mb-6">
                <!-- Opções injetadas via JS -->
            </div>

            <div class="mb-8">
                <label class="text-[10px] uppercase font-bold text-cyber opacity-70 ml-1">Observações Adicionais</label>
                <textarea id="obs-adicional-lente" class="input-clinical h-20 mt-1" placeholder="Digite aqui orientações extras para esta receita..."></textarea>
            </div>

            <div class="flex flex-col sm:flex-row gap-3">
                <button onclick="window.confirmarImpressaoReceita()" class="flex-1 btn-medical py-4 rounded-xl font-bold uppercase">Gerar Receita</button>
                <button onclick="window.closeModal('modal-lentes')" class="flex-1 bg-white/5 py-4 rounded-xl font-bold uppercase text-[10px]">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL ANIVERSARIANTES -->
    <div id="modal-aniversariantes" class="fixed inset-0 bg-black/90 backdrop-blur-md hidden z-[600] flex items-center justify-center p-4">
        <div class="glass-card bg-surface p-6 md:p-8 rounded-[2rem] w-full max-w-md shadow-2xl text-center text-white border border-medical/30">
            <div class="w-20 h-20 bg-medical/20 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="gift" class="w-10 h-10 text-medical"></i>
            </div>
            <h3 class="text-2xl font-bold mb-2 italic text-medical uppercase tracking-tighter">Aniversariantes de Hoje!</h3>
            <p id="bday-date-display" class="text-[10px] text-slate-400 uppercase font-bold tracking-widest mb-6"></p>
            
            <div id="lista-aniversariantes-modal" class="space-y-3 mb-8 max-h-[40vh] overflow-y-auto pr-2">
                <!-- Nomes e Botões injetadas via JS -->
            </div>

            <button onclick="window.closeModal('modal-aniversariantes')" class="w-full btn-medical py-4 rounded-xl font-bold uppercase shadow-lg shadow-medical/20">Acessar Sistema</button>
        </div>
    </div>

    <!-- MODAL DESENVOLVEDOR -->
    <div id="modal-dev" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden z-[800] flex items-center justify-center p-4">
        <div class="glass-card bg-surface p-8 rounded-[2.5rem] w-full max-w-sm text-center text-white border border-medical/30 shadow-2xl">
            <div class="w-16 h-16 bg-medical/10 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i data-lucide="code-2" class="w-8 h-8 text-medical"></i>
            </div>
            <h3 class="text-xl font-bold mb-4 italic text-medical uppercase tracking-widest">Suporte Técnico</h3>
            <div class="space-y-1 mb-8">
                <p class="font-black text-white text-xl uppercase tracking-tighter">Girlanildo Rodrigues</p>
                <p class="text-[10px] text-cyber font-bold uppercase tracking-[0.2em] opacity-80">Neuro Optometrista</p>
            </div>
            <div class="bg-white/5 p-4 rounded-2xl mb-8 flex items-center justify-center gap-3 border border-white/5">
                <i data-lucide="phone" class="w-4 h-4 text-medical"></i>
                <span class="text-sm font-mono font-bold">(97) 99163-2841</span>
            </div>
            <button onclick="window.closeModal('modal-dev')" class="w-full py-4 btn-medical rounded-2xl font-bold uppercase shadow-lg shadow-medical/20">Fechar Informações</button>
        </div>
    </div>

    <div id="modal-otica" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden z-[100] flex items-center justify-center p-4"><div class="glass-card bg-surface p-6 md:p-8 rounded-[1.5rem] md:rounded-[2rem] w-full max-w-md shadow-2xl text-white"><h3 class="text-xl md:text-2xl font-bold mb-6" id="title-otica">Ótica</h3><div class="space-y-4"><input type="text" id="ot-nome" placeholder="Nome" class="input-clinical text-white"><select id="ot-tipo" class="input-clinical text-white"><option value="Paciente">Por Atendimento</option><option value="Diária">Diária Fixa</option><option value="Retorno">Retorno</option></select><input type="number" id="ot-valor" placeholder="Valor R$" class="input-clinical text-white"><input type="color" id="ot-cor" class="w-full h-12 bg-transparent cursor-pointer"><div class="flex flex-col sm:flex-row gap-3 pt-4"><button onclick="window.saveOtica()" class="flex-1 btn-medical py-3 rounded-xl">SALVAR</button><button onclick="window.closeModal('modal-otica')" class="flex-1 bg-white/5 py-3 rounded-xl font-bold">FECHAR</button></div></div></div></div>
    <div id="modal-template" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden z-[100] flex items-center justify-center p-4"><div class="glass-card bg-surface p-6 md:p-8 rounded-[1.5rem] md:rounded-[2rem] w-full max-w-lg shadow-2xl text-white"><h3 class="text-xl md:text-2xl font-bold mb-4" id="title-template">Template CRM</h3><input type="text" id="t-titulo" placeholder="Título" class="input-clinical text-white mb-4"><textarea id="t-texto" rows="6" placeholder="Mensagem..." class="input-clinical text-white"></textarea><div class="flex flex-col sm:flex-row gap-3 pt-4"><button onclick="window.saveTemplate()" class="flex-1 btn-medical py-3 rounded-xl">SALVAR</button><button onclick="window.closeModal('modal-template')" class="flex-1 bg-white/5 py-3 rounded-xl font-bold">VOLTAR</button></div></div></div>
    
    <div id="modal-pick" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden z-[700] flex items-center justify-center p-4"><div class="glass-card bg-surface p-6 md:p-8 rounded-[1.5rem] md:rounded-[2rem] w-full max-w-md text-center text-white"><h3 class="text-xl font-bold mb-2 italic">Enviar Mensagem</h3><p id="target-name" class="text-medical mb-6 font-bold uppercase"></p><div id="pick-list" class="space-y-2"></div><button onclick="window.closeModal('modal-pick')" class="w-full mt-4 py-3 bg-white/5 rounded-xl font-bold uppercase text-white">Fechar</button></div></div>






<!-- MODAL PAINEL DE RESTRIÇÕES -->
<div id="modal-restricoes" class="fixed inset-0 bg-black/98 backdrop-blur-xl hidden z-[250] flex items-center justify-center p-4">
    <div class="glass-card bg-surface p-6 md:p-10 rounded-[3rem] w-full max-w-[95%] shadow-2xl text-white max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-start mb-8">
            <div>
                <h3 class="text-3xl font-black italic text-cyber uppercase tracking-tighter">Gestão de Acessos</h3>
                <p class="text-slate-500 text-[9px] font-bold uppercase tracking-[0.3em]">Permissões por conta</p>
            </div>
            <button onclick="window.openModal('modal-novo-usuario')" class="btn-medical px-6 py-3 rounded-xl flex items-center gap-2 text-xs">
                <i data-lucide="user-plus"></i> NOVO USUÁRIO
            </button>
        </div>
        <div class="overflow-x-auto flex-1">
            <table class="w-full text-left min-w-[1200px]">
                <thead class="bg-white/5 text-[9px] uppercase font-bold text-cyber">
                    <tr>
                        <th class="py-4 px-6">E-mail</th>
                        <th class="py-4 px-6 text-center">Bloquear Exclusão</th>
                        <th class="py-4 px-6 text-center">Ocultar Financeiro</th>
                        <th class="py-4 px-6 text-center">Bloquear Exames</th>
                        <th class="py-4 px-6 text-center">Ocultar Pacientes</th>
                        <th class="py-4 px-6 text-center">Ocultar Óticas</th>
                        <th class="py-4 px-6 text-center">Ocultar Mensagens</th>
                        <th class="py-4 px-6 text-center">Ocultar Configurações</th>
                        <th class="py-4 px-6 text-right">Ações</th>
                    </tr>
                </thead>
                <tbody id="lista-usuarios-sistema" class="divide-y divide-white/5"></tbody>
            </table>
        </div>
        <button onclick="window.closeModal('modal-restricoes')" class="mt-8 bg-white/5 py-4 rounded-2xl font-bold uppercase text-[10px]">FECHAR</button>
    </div>
</div>

<!-- MODAL CADASTRAR NOVO USUÁRIO -->
<div id="modal-novo-usuario" class="fixed inset-0 bg-black/90 backdrop-blur-md hidden z-[300] flex items-center justify-center p-4">
    <div class="glass-card bg-surface p-8 rounded-[2rem] w-full max-w-md shadow-2xl text-white">
        <h3 class="text-xl font-bold italic text-medical uppercase mb-6">Cadastrar Usuário</h3>
        <div class="space-y-4">
            <input type="email" id="new-user-email" class="input-clinical" placeholder="E-mail do Funcionário">
            <input type="password" id="new-user-pass" class="input-clinical" placeholder="Senha Provisória">
            <button onclick="window.saveNewUser()" class="w-full btn-medical py-3 rounded-xl font-bold">CRIAR CONTA</button>
            <button onclick="window.closeModal('modal-novo-usuario')" class="w-full bg-white/5 py-3 rounded-xl text-xs">CANCELAR</button>
        </div>
    </div>
</div>









    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, orderBy, updateDoc, where, getDocs, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";





        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";


let userPermissions = {
    lockDelete: false,
    hideFinance: false,
    lockExams: false,
    hidePatients: false,
    hideOticas: false,
    hideTemplates: false,
    hideConfig: false,
    isAdmin: false
};





        const firebaseConfig = {
            apiKey: "AIzaSyD60DbZUm3e6NPVteWtHY3T86ACi1ys5VY",
            authDomain: "agendaatendimento-473c1.firebaseapp.com",
            projectId: "agendaatendimento-473c1",
            storageBucket: "agendaatendimento-473c1.firebasestorage.app",
            messagingSenderId: "624037217398",
            appId: "1:624037217398:web:90887ae72197d6f6278b57",
            measurementId: "G-04J2905PQJ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // VARIÁVEIS GLOBAIS DE CONTROLE
        window.bdayNotified = false;
        window.anivSendoProcessado = null; 
        window.clinicData = null; // Armazena dados da clínica

        window.formatarDataBR = (data) => {
            if (!data) return "";
            if (data.includes('/')) return data;
            const partes = data.split('-');
            if (partes.length !== 3) return data;
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        };

        // LOGIN E AUTH
        document.getElementById('auth-email').addEventListener('keypress', (e) => { if(e.key === 'Enter') window.handleAuth(); });
        document.getElementById('auth-password').addEventListener('keypress', (e) => { if(e.key === 'Enter') window.handleAuth(); });
        
        window.showDevInfo = () => { window.openModal('modal-dev'); };

        window.handleAuth = async () => { 
            const email = document.getElementById('auth-email').value; 
            const pass = document.getElementById('auth-password').value; 
            if(!email || !pass) return alert("Preencha as credenciais."); 
            try { 
                await signInWithEmailAndPassword(auth, email, pass); 
                document.getElementById('auth-email').value = ""; 
                document.getElementById('auth-password').value = ""; 
            } catch (e) { 
                alert("E-mail ou Senha inválido"); 
            } 
        };

        window.handleLogout = () => { 
            if(confirm("Deseja sair do sistema?")) { 
                signOut(auth).then(() => { 
                    window.bdayNotified = false; 
                    location.reload(); 
                }); 
            } 
        };








onAuthStateChanged(auth, async (user) => { 
    const authContainer = document.getElementById('auth-container'); 
    const mainApp = document.getElementById('main-app'); 
    
    if (user) { 
        // 1. Busca os dados e permissões do usuário diretamente no Firestore
        const userDoc = await getDoc(doc(db, "usuarios", user.uid));
        
        if(userDoc.exists()) {
            // Define todas as permissões baseadas no que está no banco
            userPermissions = userDoc.data();
        } else {
            // Caso o usuário exista no Auth mas não no Firestore (segurança extra)
            userPermissions = { isAdmin: false };
        }
        
        // Se o campo isAdmin for true no banco, ele terá acesso total
        applyPermissions(); 
        
        authContainer.classList.add('hidden'); 
        mainApp.classList.remove('hidden'); 
        window.loadClinicData(); 
        if (pacientes.length > 0) window.verificarAniversariantes(pacientes);
    } else { 
        authContainer.classList.remove('hidden'); 
        mainApp.classList.add('hidden'); 
    } 
});






        // FUNÇÕES DA CLÍNICA (CONFIGURAÇÃO COM BLOQUEIO)
        window.toggleClinicFields = (readonly) => {
            const container = document.getElementById('aba-config-clinica');
            const inputs = container.querySelectorAll('input:not([type="hidden"])');
            inputs.forEach(input => input.disabled = readonly);

            const btnEdit = document.getElementById('btn-edit-clinic');
            const btnSave = document.getElementById('btn-save-clinic');
            const btnChoice = document.getElementById('btn-choice-logo');

            if (readonly) {
                btnEdit.classList.remove('hidden');
                btnSave.classList.add('hidden');
                btnChoice.classList.add('hidden');
            } else {
                btnEdit.classList.add('hidden');
                btnSave.classList.remove('hidden');
                btnChoice.classList.remove('hidden');
            }
        };

        window.enableClinicEdit = () => {
            window.toggleClinicFields(false);
        };

        window.previewAndStoreLogo = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('conf-logo-preview').src = e.target.result;
                    document.getElementById('conf-logo-base64').value = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.saveClinicData = async () => {
            const data = {
                nome: document.getElementById('conf-clinica-nome').value,
                slogan: document.getElementById('conf-clinica-slogan').value,
                cnpj: document.getElementById('conf-clinica-cnpj').value,
                tel: document.getElementById('conf-clinica-tel').value,
                endereco: document.getElementById('conf-clinica-endereco').value,
                cidade: document.getElementById('conf-clinica-cidade').value,
                cep: document.getElementById('conf-clinica-cep').value,
                email: document.getElementById('conf-clinica-email').value,
                resp: document.getElementById('conf-clinica-resp').value,
                registro: document.getElementById('conf-clinica-registro').value,
                logo: document.getElementById('conf-logo-base64').value
            };
            try {
                await setDoc(doc(db, "configuracoes", "clinica"), data);
                alert("Configurações da clínica salvas com sucesso!");
                window.toggleClinicFields(true); // Bloqueia após salvar
                window.loadClinicData();
            } catch (e) { alert("Erro ao salvar: " + e.message); }
        };

        window.loadClinicData = async () => {
            const docSnap = await getDoc(doc(db, "configuracoes", "clinica"));
            if (docSnap.exists()) {
                const d = docSnap.data();
                window.clinicData = d;
                document.getElementById('conf-clinica-nome').value = d.nome || "";
                document.getElementById('conf-clinica-slogan').value = d.slogan || "";
                document.getElementById('conf-clinica-cnpj').value = d.cnpj || "";
                document.getElementById('conf-clinica-tel').value = d.tel || "";
                document.getElementById('conf-clinica-endereco').value = d.endereco || "";
                document.getElementById('conf-clinica-cidade').value = d.cidade || "";
                document.getElementById('conf-clinica-cep').value = d.cep || "";
                document.getElementById('conf-clinica-email').value = d.email || "";
                document.getElementById('conf-clinica-resp').value = d.resp || "";
                document.getElementById('conf-clinica-registro').value = d.registro || "";
                
                if(d.logo) {
                    document.getElementById('conf-logo-preview').src = d.logo;
                    document.getElementById('conf-logo-base64').value = d.logo;
                    document.getElementById('img-login-logo').src = d.logo;
                    document.getElementById('img-sidebar-logo').src = d.logo;
                    document.getElementById('img-header-mobile-logo').src = d.logo;
                }
            }
            window.toggleClinicFields(true); // Garante que começa bloqueado
        };

        let oticas = [], pacientes = [], templates = [], editPId = null, editOId = null, editTId = null, editEId = null, filtroStatus = "Todos", filtroOtica = "", filtroPagoAgenda = "Todos", filtroMesAgenda = "", filtroDataAgendado = "", filtroBuscaPaciente = "", filtroBuscaAgenda = "";
        const now = new Date();
        document.getElementById('display-date').innerText = new Intl.DateTimeFormat('pt-BR', { dateStyle: 'full' }).format(now);
        document.getElementById('filtro-mes').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        
        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('open'); }
        window.nav = (id) => { 
            document.querySelectorAll('.content-sec').forEach(s => s.classList.add('hidden')); 
            document.getElementById('sec-' + id).classList.remove('hidden'); 
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active')); 
            const targetBtn = Array.from(document.querySelectorAll('.nav-item')).find(btn => btn.getAttribute('onclick').includes(`nav('${id}')`)); 
            if(targetBtn) targetBtn.classList.add('active'); 
            if(window.innerWidth < 1024) toggleSidebar(); 
        };

        window.switchConfigTab = (tab) => {
            document.querySelectorAll('.config-pane').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('#sec-configuracoes .tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('aba-config-' + tab).classList.remove('hidden');
            document.getElementById('tab-config-' + tab).classList.add('active');
        };

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => { 
            document.getElementById(id).classList.add('hidden'); 
            if(id === 'modal-paciente') window.togglePatientFields(false); 
        };

        window.openModalCadastro = (tipo) => {
            if(tipo === 'paciente') { 
                editPId = null; document.getElementById('title-paciente').innerText = "Novo Agendamento"; 
                const campos = ['p-nome', 'p-nascimento', 'p-idade-calc', 'p-cpf', 'p-tel', 'p-origem', 'p-profissao', 'p-passatempo', 'p-endereco', 'p-ultimo-exame', 'p-ajuda', 'p-responsavel', 'p-data-agenda', 'p-hora'];
                campos.forEach(id => { if(document.getElementById(id)) document.getElementById(id).value = ""; });
                if(document.getElementById('p-sexo')) document.getElementById('p-sexo').value = "M";
                if(document.getElementById('p-otica')) document.getElementById('p-otica').value = "";
                if(document.getElementById('p-status-modal')) document.getElementById('p-status-modal').value = "Recepção";
                if(document.getElementById('p-pago-modal')) document.getElementById('p-pago-modal').value = "Pendente";
                window.togglePatientFields(false); 
                window.switchTab('cadastro'); window.openModal('modal-paciente'); 
            }
            else if(tipo === 'otica') { editOId = null; document.getElementById('ot-nome').value = ""; document.getElementById('ot-valor').value = ""; document.getElementById('title-otica').innerText = "Cadastrar Ótica"; window.openModal('modal-otica'); }
            else { editTId = null; document.getElementById('t-titulo').value = ""; document.getElementById('t-texto').value = ""; document.getElementById('title-template').innerText = "Novo Template"; window.openModal('modal-template'); }
        };

        window.switchTab = (tab) => { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('tab-btn-' + tab).classList.add('active'); if(tab === 'cadastro') { document.getElementById('aba-cadastro').classList.remove('hidden'); document.getElementById('aba-historico').classList.add('hidden'); } else { document.getElementById('aba-cadastro').classList.add('hidden'); document.getElementById('aba-historico').classList.remove('hidden'); renderHistoricoCompleto(); } }
        window.openExame = () => { editEId = null; document.getElementById('title-modal-exame').innerText = "Novo Exame Clínico"; const campos = ['rx-od-esf','rx-od-cil','rx-od-eixo','rx-od-av','rx-od-av-perto','rx-oe-esf','rx-oe-cil','rx-oe-eixo','rx-oe-av','rx-oe-av-perto','rx-add','rx-dp','oft-bruckner','oft-od-papila','oft-oe-papila','oft-od-escav','oft-oe-escav','oft-od-macula','oft-oe-macula','oft-od-fixacao','oft-oe-fixacao','oft-od-relacao-av','oft-oe-relacao-av','oft-od-cor','oft-oe-cor','oft-od-lente','oft-oe-lente','oft-obs']; campos.forEach(id => { if(document.getElementById(id)) document.getElementById(id).value = ""; }); window.openModal('modal-exame'); };
        
        window.formatDegree = (i) => { if(i.value && !i.value.includes('°')) i.value += '°'; };
        window.formatAV = (i) => { if(i.value && !i.value.startsWith('20/')) i.value = '20/' + i.value; };
        window.formatAVPerto = (i) => { if(i.value && !i.value.toUpperCase().startsWith('J')) i.value = 'J' + i.value.toUpperCase(); };
        window.formatADD = (i) => { let val = i.value.trim().replace('+', '').replace(',', '.'); if (val === "") return; let num = parseFloat(val); if (!isNaN(num)) i.value = '+' + num.toFixed(2).replace('.', ','); };
        window.formatLens = (i) => { let original = i.value.trim(); let val = original.replace(',', '.'); if (val === "" || val === "+" || val === "-") return; let num = parseFloat(val); if (!isNaN(num)) { let formatted = num.toFixed(2).replace('.', ','); if(original.startsWith('+') && !formatted.startsWith('+')) formatted = '+' + formatted; i.value = formatted; } };
        window.mascaraCPF = (i) => { let v = i.value.replace(/\D/g, ""); if (v.length > 11) v = v.substring(0, 11); v = v.replace(/(\d{3})(\d)/, "$1.$2"); v = v.replace(/(\d{3})(\d)/, "$1.$2"); v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2"); i.value = v; };
        window.mascaraTelefone = (i) => { let v = i.value.replace(/\D/g, ""); if (v.length > 11) v = v.substring(0, 11); if (v.length >= 11) v = v.replace(/^(\d{2})(\d{5})(\d{4})/, "($1) $2-$3"); else if (v.length >= 4) v = v.replace(/^(\d{2})(\d{4,5})/, "($1) $2"); i.value = v; };
        window.updateAge = (nascimento) => { if(!nascimento) return; const birth = new Date(nascimento + 'T00:00:00'); const now = new Date(); let age = now.getFullYear() - birth.getFullYear(); const m = now.getMonth() - birth.getMonth(); if (m < 0 || (m === 0 && now.getDate() < birth.getDate())) age--; document.getElementById('p-idade-calc').value = `${age} anos`; };
        window.autoFillPaciente = (nome) => { if(nome.length < 3) return; const p = pacientes.find(item => item.nome.toLowerCase() === nome.toLowerCase()); if(p && !editPId) { document.getElementById('p-tel').value = p.tel || ""; document.getElementById('p-nascimento').value = p.nascimento || ""; document.getElementById('p-cpf').value = p.cpf || ""; window.updateAge(p.nascimento); document.getElementById('p-sexo').value = p.sexo || "M"; document.getElementById('p-origem').value = p.origem || ""; document.getElementById('p-profissao').value = p.profissao || ""; document.getElementById('p-passatempo').value = p.passatempo || ""; document.getElementById('p-endereco').value = p.endereco || ""; document.getElementById('p-ultimo-exame').value = p.ultimoExame || ""; document.getElementById('p-ajuda').value = p.ajuda || ""; document.getElementById('p-responsavel').value = p.responsavel || ""; } };
        
        window.saveExame = async () => { 
            const nome = document.getElementById('p-nome').value; 
            if(!nome) return alert("Informe o nome do paciente."); 
            const dataExame = { 
                pacienteNome: nome, 
                data: editEId ? document.getElementById('title-modal-exame').getAttribute('data-date') : new Date().toLocaleDateString('pt-BR'), 
                timestamp: editEId ? parseInt(document.getElementById('title-modal-exame').getAttribute('data-ts')) : Date.now(), 
                rx_od_esf: document.getElementById('rx-od-esf').value, 
                rx_od_cil: document.getElementById('rx-od-cil').value, 
                rx_od_eixo: document.getElementById('rx-od-eixo').value, 
                rx_od_av: document.getElementById('rx-od-av').value, 
                rx_od_av_perto: document.getElementById('rx-od-av-perto').value, 
                rx_oe_esf: document.getElementById('rx-oe-esf').value, 
                rx_oe_cil: document.getElementById('rx-oe-cil').value, 
                rx_oe_eixo: document.getElementById('rx-oe-eixo').value, 
                rx_oe_av: document.getElementById('rx-oe-av').value, 
                rx_oe_av_perto: document.getElementById('rx-oe-av-perto').value, 
                rx_add: document.getElementById('rx-add').value, 
                rx_dp: document.getElementById('rx-dp').value, 
                oft_bruckner: document.getElementById('oft-bruckner').value, 
                oft_od_papila: document.getElementById('oft-od-papila').value, 
                oft_oe_papila: document.getElementById('oft-oe-papila').value, 
                oft_od_escav: document.getElementById('oft-od-escav').value, 
                oft_oe_escav: document.getElementById('oft-oe-escav').value, 
                oft_od_macula: document.getElementById('oft-od-macula').value, 
                oft_oe_macula: document.getElementById('oft-oe-macula').value, 
                oft_od_fixacao: document.getElementById('oft-od-fixacao').value, 
                oft_oe_fixacao: document.getElementById('oft-oe-fixacao').value, 
                oft_od_relacao_av: document.getElementById('oft-od-relacao-av').value, 
                oft_oe_relacao_av: document.getElementById('oft-oe-relacao-av').value, 
                oft_od_cor: document.getElementById('oft-od-cor').value, 
                oft_oe_cor: document.getElementById('oft-oe-cor').value, 
                oft_od_lente: document.getElementById('oft-od-lente').value, 
                oft_oe_lente: document.getElementById('oft-oe-lente').value, 
                oft_obs: document.getElementById('oft-obs').value 
            }; 
            if(editEId) await updateDoc(doc(db, "historicos", editEId), dataExame); 
            else await addDoc(collection(db, "historicos"), dataExame); 
            window.closeModal('modal-exame'); 
            renderHistoricoCompleto(); 
        };

        window.editExame = async (id) => { const docRef = doc(db, "historicos", id); const docSnap = await getDoc(docRef); if (docSnap.exists()) { const h = docSnap.data(); editEId = id; document.getElementById('title-modal-exame').innerText = "Editar Exame Clínico"; document.getElementById('title-modal-exame').setAttribute('data-date', h.data); document.getElementById('title-modal-exame').setAttribute('data-ts', h.timestamp); const campos = { 'rx-od-esf': h.rx_od_esf, 'rx-od-cil': h.rx_od_cil, 'rx-od-eixo': h.rx_od_eixo, 'rx-od-av': h.rx_od_av, 'rx-od-av-perto': h.rx_od_av_perto, 'rx-oe-esf': h.rx_oe_esf, 'rx-oe-cil': h.rx_oe_cil, 'rx-oe-eixo': h.rx_oe_eixo, 'rx-oe-av': h.rx_oe_av, 'rx-oe-av-perto': h.rx_oe_av_perto, 'rx-add': h.rx_add, 'rx-dp': h.rx_dp, 'oft-bruckner': h.oft_bruckner, 'oft-od-papila': h.oft_od_papila, 'oft-oe-papila': h.oft_oe_papila, 'oft-od-escav': h.oft_od_escav, 'oft-oe-escav': h.oft_oe_escav, 'oft-od-macula': h.oft_od_macula, 'oft-oe-macula': h.oft_oe_macula, 'oft-od-fixacao': h.oft_od_fixacao, 'oft-oe-fixacao': h.oft_oe_fixacao, 'oft-od-relacao-av': h.oft_od_relacao_av, 'oft-oe-relacao-av': h.oft_oe_relacao_av, 'oft-od-cor': h.oft_od_cor, 'oft-oe-cor': h.oft_oe_cor, 'oft-od-lente': h.oft_od_lente, 'oft-oe-lente': h.oft_oe_lente, 'oft-obs': h.oft_obs }; for (let key in campos) { if(document.getElementById(key)) document.getElementById(key).value = campos[key] || ""; } window.openModal('modal-exame'); } };

        async function renderHistoricoCompleto() {
            const nome = document.getElementById('p-nome').value; const container = document.getElementById('historico-render'); container.innerHTML = '<p class="text-xs animate-pulse text-medical">Buscando...</p>';
            const q = query(collection(db, "historicos"), where("pacienteNome", "==", nome)); const querySnapshot = await getDocs(q); if(querySnapshot.empty) { container.innerHTML = '<div class="py-10 text-center opacity-30 uppercase text-xs">Nenhum exame.</div>'; return; }
            container.innerHTML = ""; const docs = querySnapshot.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.timestamp - a.timestamp);
            docs.forEach((h) => { container.innerHTML += `<div class="glass-card p-4 md:p-6 rounded-3xl border-l-4 border-medical bg-white/[0.02]"><div class="flex justify-between items-center mb-4"><span class="text-[10px] bg-medical px-2 py-1 rounded-lg font-bold uppercase">EXAME EM ${h.data}</span><div class="flex gap-2"><button onclick="window.editExame('${h.id}')" class="text-medical p-2"><i data-lucide="edit-3" class="w-4"></i></button><button onclick="window.apagar('historicos', '${h.id}')" class="text-red-500 p-2"><i data-lucide="trash-2" class="w-4"></i></button></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div class="bg-white/5 p-4 rounded-xl"><h5 class="text-cyber text-[20px] font-bold uppercase mb-2">RX FINAL - OD</h5><p class="text-cyber text-white text-[20px] font-bold">ESF: ${h.rx_od_esf || '-'} | CIL: ${h.rx_od_cil || '-'} | EIXO: ${h.rx_od_eixo || '-'}</p><p class="text-[20px] opacity-50 mt-1 uppercase font-mono">AV: ${h.rx_od_av || '-'} / ${h.rx_od_av_perto || '-'}</p></div><div class="bg-white/5 p-4 rounded-xl"><h5 class="text-cyber text-[20px] font-bold uppercase mb-2">RX FINAL - OE</h5><p class="text-cyber text-white text-[20px] font-bold">ESF: ${h.rx_oe_esf || '-'} | CIL: ${h.rx_oe_cil || '-'} | EIXO: ${h.rx_oe_eixo || '-'}</p><p class="text-[20px] opacity-50 mt-1 uppercase font-mono">AV: ${h.rx_oe_av || '-'} / ${h.rx_oe_av_perto || '-'}</p></div></div><div class="bg-medical/10 border border-medical/20 p-3 rounded-xl mb-4 flex justify-between items-center px-4 md:px-6"><span class="text-[10px] font-bold uppercase text-medical">Adição (ADD)</span><span class="text-lg font-bold text-white">${h.rx_add || '---'}</span></div><div class="overflow-hidden border border-white/5 rounded-xl mb-4"><div class="overflow-x-auto"><table class="w-full text-[10px] text-center min-w-[300px]"><thead class="bg-white/5 text-cyber uppercase"><tr><th class="p-2">Aspectos</th><th class="p-2">OD</th><th class="p-2">OE</th></tr></thead><tbody class="divide-y divide-white/5"><tr><td class="p-2 opacity-40">Papila</td><td>${h.oft_od_papila || '-'}</td><td>${h.oft_oe_papila || '-'}</td></tr><tr><td class="p-2 opacity-40">Escavação</td><td>${h.oft_od_escav || '-'}</td><td>${h.oft_oe_escav || '-'}</td></tr><tr><td class="p-2 opacity-40">Mácula</td><td>${h.oft_od_macula || '-'}</td><td>${h.oft_oe_macula || '-'}</td></tr><tr><td class="p-2 opacity-40">Fixação</td><td>${h.oft_od_fixacao || '-'}</td><td>${h.oft_oe_fixacao || '-'}</td></tr><tr><td class="p-2 opacity-40">Relação A/V</td><td>${h.oft_od_relacao_av || '-'}</td><td>${h.oft_oe_relacao_av || '-'}</td></tr><tr><td class="p-2 opacity-40">Cor</td><td>${h.oft_od_cor || '-'}</td><td>${h.oft_oe_cor || '-'}</td></tr><tr><td class="p-2 opacity-40">Lente</td><td>${h.oft_od_lente || '-'}</td><td>${h.oft_oe_lente || '-'}</td></tr></tbody></table></div></div><div class="flex flex-wrap gap-4 text-[10px] font-bold"><div>DP: <span class="text-medical">${h.rx_dp || '-'}</span></div><div>BRUCKNER: <span class="text-medical">${h.oft_bruckner || '-'}</span></div></div>${h.oft_obs ? `<div class="mt-4 p-3 bg-white/5 rounded-xl text-[11px] italic opacity-80 border">Obs: ${h.oft_obs}</div>` : ''}</div>`; }); lucide.createIcons();
        }

        window.savePatient = async () => { const oId = document.getElementById('p-otica').value; const oRel = oticas.find(o => o.id === oId); const data = { nome: document.getElementById('p-nome').value, sexo: document.getElementById('p-sexo').value, nascimento: document.getElementById('p-nascimento').value, idadeText: document.getElementById('p-idade-calc').value, cpf: document.getElementById('p-cpf').value, tel: document.getElementById('p-tel').value, origem: document.getElementById('p-origem').value, profissao: document.getElementById('p-profissao').value, passatempo: document.getElementById('p-passatempo').value, endereco: document.getElementById('p-endereco').value, ultimoExame: document.getElementById('p-ultimo-exame').value, ajuda: document.getElementById('p-ajuda').value, responsavel: document.getElementById('p-responsavel').value, data: document.getElementById('p-data-agenda').value, hora: document.getElementById('p-hora').value, status: document.getElementById('p-status-modal').value, pago: document.getElementById('p-pago-modal').value === "Pago", oticaId: oId, oticaNome: oRel ? oRel.nome : "Particular", oticaCor: oRel ? oRel.cor : "#ffffff", valorConsulta: (oRel && oRel.tipo === 'Paciente') ? oRel.valor : 0 }; if(editPId) await updateDoc(doc(db, "pacientes", editPId), data); else await addDoc(collection(db, "pacientes"), {...data, created: Date.now()}); window.closeModal('modal-paciente'); };

        // RELATÓRIOS E IMPRESSÕES
        window.imprimirLista = () => {
            let f = pacientes;
            const perOpcao = prompt("Deseja imprimir a lista referente a:\n1 - Mês inteiro\n2 - Período específico do mês (ex: dia 01 a 15)");
            if (perOpcao === null) return;
            let subtituloPeriodo = "Relatório Geral";
            if (perOpcao === "2") {
                const de = prompt("Dia Inicial (ex: 01):", "01");
                const ate = prompt("Dia Final (ex: 15):", "15");
                if (de && ate) {
                    const diaInicio = parseInt(de);
                    const diaFim = parseInt(ate);
                    subtituloPeriodo = `Período do dia ${diaInicio} ao dia ${diaFim}`;
                    f = f.filter(p => {
                        if (!p.data) return false;
                        const diaP = parseInt(p.data.split('-')[2]);
                        return diaP >= diaInicio && diaP <= diaFim;
                    });
                }
            }
            if (filtroStatus === "Agendado" && filtroDataAgendado !== "") f = f.filter(p => p.status === "Agendado" && p.data === filtroDataAgendado);
            else if (filtroStatus !== "Todos") f = f.filter(p => f.status === filtroStatus);
            if (filtroOtica !== "") f = f.filter(p => p.oticaId === filtroOtica);
            if (filtroMesAgenda !== "") f = f.filter(p => p.data && p.data.startsWith(filtroMesAgenda));
            if(f.length === 0) return alert("A lista atual está vazia para os parâmetros selecionados.");
            f.sort((a, b) => (a.data + a.hora).localeCompare(b.data + b.hora));
            let totalPago = 0; let totalPendente = 0;
            const nomeOtica = filtroOtica ? (oticas.find(o => o.id === filtroOtica)?.nome || "Geral") : "Geral";
            
            const clinicLogo = window.clinicData?.logo || "";

            const win = window.open('', '', 'height=700,width=900');
            win.document.write('<html><head><title>Relatório de Pacientes</title><style>@page { size: portrait; margin: 15mm; } body{font-family:sans-serif;padding:30px;color:#333} .header-rep { display: flex; align-items: center; gap: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; } .header-rep img { height: 60px; } table{width:100%;border-collapse:collapse;margin-top:20px} th,td{border:1px solid #ddd;padding:10px;text-align:left;font-size:12px} th{background:#f8fafc;text-transform:uppercase} .summary{margin-top:30px;padding:20px;background:#f1f5f9;border-radius:10px} .total-line{display:flex;justify-content:space-between;margin-bottom:5px;font-weight:bold} .pago{color:#16a34a} .pendente{color:#dc2626}</style></head><body>');
            win.document.write(`<div class="header-rep">${clinicLogo ? `<img src="${clinicLogo}">` : ''} <div><h1>Lista de Clientes - ${nomeOtica}</h1><p><b>${subtituloPeriodo}</b> | Gerado em: ${new Date().toLocaleDateString('pt-BR')}</p></div></div>`);
            win.document.write('<table><thead><tr><th>Data</th><th>Hora</th><th>Paciente</th><th>Status</th><th>Valor</th><th>Pagamento</th></tr></thead><tbody>');
            f.forEach(p => {
                const val = parseFloat(p.valorConsulta || 0); if(p.pago) totalPago += val; else totalPendente += val;
                win.document.write(`<tr><td>${window.formatarDataBR(p.data)}</td><td>${p.hora}</td><td>${p.nome}</td><td>${p.status}</td><td>R$ ${val.toFixed(2)}</td><td>${p.pago ? 'Pago' : 'Pendente'}</td></tr>`);
            });
            win.document.write(`</tbody></table><div class="summary"><div class="total-line pago"><span>Total Já Pago:</span> <span>R$ ${totalPago.toFixed(2)}</span></div><div class="total-line pendente"><span>Total Pendente:</span> <span>R$ ${totalPendente.toFixed(2)}</span></div><div class="total-line" style="border-top:1px solid #ccc; padding-top:10px; margin-top:10px; font-size:16px"><span>VALOR TOTAL (PAGOS + PENDENTES):</span> <span>R$ ${(totalPago + totalPendente).toFixed(2)}</span></div></div></body></html>`);
            win.document.close(); win.print();
        };

        // GERAÇÃO DE RECEITA
        let currentPrintId = null;
        let selectedLenses = [];
        const lensOptions = ["MULTIFOCAIS", "V. SIMPLES", "BIFOCAIS", "POLICARBONATO", "FILTRO AZUL", "FOTOCROMÁTICA", "TRANSITIONS", "ANTIRREFLEXO", "CRIZAL"];

        window.imprimirReceita = (id) => {
            currentPrintId = id;
            selectedLenses = [];
            const extraField = document.getElementById('obs-adicional-lente');
            if(extraField) extraField.value = "";
            renderLensesSelector();
            window.openModal('modal-lentes');
        };

        function renderLensesSelector() {
            const grid = document.getElementById('lentes-grid');
            grid.innerHTML = "";
            lensOptions.forEach(opt => {
                const isSelected = selectedLenses.includes(opt);
                const order = selectedLenses.indexOf(opt) + 1;
                grid.innerHTML += `<div onclick="window.toggleLente('${opt}')" class="lente-opt p-4 rounded-xl font-bold text-[10px] flex justify-between items-center ${isSelected ? 'selected' : ''}"><span>${opt}</span><div class="order-badge">${order}</div></div>`;
            });
        }

        window.toggleLente = (opt) => {
            const idx = selectedLenses.indexOf(opt);
            if(idx > -1) selectedLenses.splice(idx, 1);
            else selectedLenses.push(opt);
            renderLensesSelector();
        };

        window.confirmarImpressaoReceita = async () => {
            const extraManual = document.getElementById('obs-adicional-lente').value;
            window.closeModal('modal-lentes');
            const id = currentPrintId;
            const p = pacientes.find(i => i.id === id);
            if(!p) return;
            const q = query(collection(db, "historicos"), where("pacienteNome", "==", p.nome));
            const querySnapshot = await getDocs(q);
            const exames = querySnapshot.docs.map(d => d.data()).sort((a,b) => b.timestamp - a.timestamp);
            const h = exames[0] || {};
            const dataAtual = new Date();
            const retornoDate = new Date();
            retornoDate.setFullYear(retornoDate.getFullYear() + 1);
            const diasSemana = ["domingo", "segunda-feira", "terça-feira", "quarta-feira", "quinta-feira", "sexta-feira", "sábado"];
            const meses = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
            const clinic = window.clinicData || {};
            const localDateStr = `${clinic.cidade || 'Coari-AM'}, ${diasSemana[dataAtual.getDay()]}, ${dataAtual.getDate()} de ${meses[dataAtual.getMonth()]} de ${dataAtual.getFullYear()}`;
            
            const lentesTexto = selectedLenses.length > 0 ? selectedLenses.join(", ") : "";
            let partesObs = [];
            if(lentesTexto) partesObs.push(lentesTexto);
            if(extraManual) partesObs.push(extraManual);
            if(h.oft_obs) partesObs.push(h.oft_obs);
            const obsFinal = partesObs.join("<br>");
            const checkX = (label) => selectedLenses.includes(label) ? "X" : "";
            
            const clinicLogo = clinic.logo || "";

            const win = window.open('', '', 'height=800,width=600');
            win.document.write(`<html><head><title>Receituário Optométrico</title><style>@page { size: A5 portrait; margin: 8mm; } body { font-family: sans-serif; padding: 0; color: #000; font-size: 11px; line-height: 1.4; } .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 8px; margin-bottom: 12px; } .header img { height: 50px; margin-bottom: 5px; } .header h1 { font-size: 18px; text-transform: uppercase; margin: 0; letter-spacing: 1px; } .patient-info { margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 5px; } .patient-info div { margin-bottom: 3px; } .section-title { text-align: center; font-weight: bold; margin: 10px 0 5px 0; font-size: 13px; text-decoration: underline; } table { width: 100%; border-collapse: collapse; margin-bottom: 10px; } th, td { border: 1px solid #000; padding: 5px; text-align: center; font-size: 11px; } th { background: #f2f2f2; } .rx-main-table th { width: 50px; } .checkbox-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 12px 0; } .checkbox-item { display: flex; align-items: center; gap: 4px; text-transform: uppercase; font-size: 10px; font-weight: bold; } .box { width: 12px; height: 12px; border: 1px solid #000; display: inline-block; font-weight: bold; line-height: 12px; text-align:center; } .obs-area { margin-top: 10px; border: 1px solid #000; padding: 8px; min-height: 50px; background: #fff; line-height: 1.5; } .footer-date { margin-top: 20px; text-align: left; font-style: italic; font-size: 12px; } .signature-block { margin-top: 40px; text-align: center; } .signature-line { border-top: 1px solid #000; width: 220px; margin: 0 auto; padding-top: 5px; font-weight: bold; font-size: 11px; } .instrucoes { margin-top: 25px; border: 1px solid #aaa; padding: 8px; font-size: 10px; text-align: center; background: #f9f9f9; line-height: 1.3; }</style></head><body><div class="header">${clinicLogo ? `<img src="${clinicLogo}">` : ''}<h1>Receituário Optométrico</h1></div><div class="patient-info"><div>Sr.(a): <b>${p.nome.toUpperCase()}</b></div><div style="display:flex; justify-content:space-between"><span>Idade: <b>${p.idadeText || ''}</b></span><span>Retorno: <b>${retornoDate.toLocaleDateString('pt-BR')}</b></span></div></div><div class="section-title">PRESCRIÇÃO</div><table class="rx-main-table"><thead><tr><th></th><th>ESFÉRICO</th><th>CILÍNDRICO</th><th>EIXO</th><th>DP/DNP</th><th>AV</th></tr></thead><tbody><tr><th>OD</th><td><b>${h.rx_od_esf || ''}</b></td><td><b>${h.rx_od_cil || ''}</b></td><td><b>${h.rx_od_eixo || ''}</b></td><td>${h.rx_dp || ''}</td><td>${h.rx_od_av || ''}</td></tr><tr><th>OE</th><td><b>${h.rx_oe_esf || ''}</b></td><td><b>${h.rx_oe_cil || ''}</b></td><td><b>${h.rx_oe_eixo || ''}</b></td><td>${h.rx_dp || ''}</td><td>${h.rx_oe_av || ''}</td></tr></tbody></table><div class="section-title">AV DE PERTO / ADIÇÃO</div><table style="width: 100%;"><thead><tr><th>AV PERTO (OD)</th><th>AV PERTO (OE)</th><th>ADIÇÃO (ADD)</th></tr></thead><tbody><tr><td>${h.rx_od_av_perto || ''}</td><td>${h.rx_oe_av_perto || ''}</td><td style="font-size:14px"><b>${h.rx_add || ''}</b></td></tr></tbody></table><div class="checkbox-group"><div class="checkbox-item"><div class="box">${checkX("MULTIFOCAIS")}</div> MULTIFOCAIS</div><div class="checkbox-item"><div class="box">${checkX("V. SIMPLES")}</div> V. SIMPLES</div><div class="checkbox-item"><div class="box">${checkX("BIFOCAIS")}</div> BIFOCAIS</div><div class="checkbox-item"><div class="box">${checkX("POLICARBONATO")}</div> POLICARBONATO</div><div class="checkbox-item"><div class="box">${checkX("FILTRO AZUL")}</div> FILTRO AZUL</div><div class="checkbox-item"><div class="box">${checkX("FOTOCROMÁTICA")}</div> FOTOCROMÁTICA</div><div class="checkbox-item"><div class="box">${checkX("TRANSITIONS")}</div> TRANSITIONS</div><div class="checkbox-item"><div class="box">${checkX("ANTIRREFLEXO")}</div> ANTIRREFLEXO</div><div class="checkbox-item"><div class="box">${checkX("CRIZAL")}</div> CRIZAL</div></div><div class="obs-area"><b>OBSERVAÇÕES:</b><br>${obsFinal}</div><div class="footer-date">${localDateStr}</div><div class="signature-block"><div class="signature-line">${clinic.resp || 'Girlanildo da Costa Rodrigues'}<br>${clinic.registro || 'Optometrista | CBOO: 04.00163-1'}</div></div><div class="instrucoes"><b>ORIENTAÇÕES AO PACIENTE:</b><br><b>Traga seus óculos para conferência.</b><br><b>Nos 20 primeiros dias de uso, é normal sentir tonturas, dor de cabeça, ver desníveis, etc.</b><br><b>Um exame de vista é sempre oportuno antes de seu filho começar a estudar.</b><br><b>Depois dos 40 anos, seja mais frequente ao OPTOMETRISTA (oculista).</b><br></div></body></html>`);
            win.document.close(); win.print();
        };

        // RECIBOS
        window.valorPorExtenso = (valor) => {
            if (!valor || valor <= 0) return "Zero Reais";
            const unidades = ["", "Um", "Dois", "Três", "Quatro", "Cinco", "Seis", "Sete", "Oito", "Nove"];
            const dezena10 = ["Dez", "Onze", "Doze", "Treze", "Quaturze", "Quinze", "Dezesseis", "Dezessete", "Dezoito", "Dezenove"];
            const dezenas = ["", "", "Vinte", "Trinta", "Quarenta", "Cinquenta", "Sessenta", "Setenta", "Oitenta", "Noventa"];
            const centenas = ["", "Cento", "Duzentos", "Trezentos", "Quatrocentos", "Quinhentos", "Seiscentos", "Setecentos", "Oitocentos", "Novecentos"];
            let v = Math.floor(valor); let texto = ""; if (v >= 1000) { let mil = Math.floor(v / 1000); texto += (mil === 1 ? "Um Mil" : converter(mil) + " Mil"); v %= 1000; if (v > 0) texto += " e "; }
            function converter(n) { if (n === 100) return "Cem"; let c = Math.floor(n / 100), d = Math.floor((n % 100) / 10), u = n % 10; let res = centenas[c]; if (res && (d || u)) res += " e "; if (d === 1) res += dezena10[u]; else { res += dezenas[d]; if (dezenas[d] && u) res += " e "; res += unidades[u]; } return res; }
            if (v > 0) texto += converter(v); return texto + " Reais";
        };

        window.imprimirReciboIndividual = (id) => {
            const p = pacientes.find(i => i.id === id);
            if(!p) return;
            const fPag = prompt("Escolha a forma de pagamento:\n1 - Dinheiro\n2 - Cart. de Crédito/Débito\n3 - Transferência Bancária/PIX");
            if(fPag === null) return;
            let op1 = "[ ]", op2 = "[ ]", op3 = "[ ]";
            if(fPag === "1") op1 = "[X]"; else if(fPag === "2") op2 = "[X]"; else if(fPag === "3") op3 = "[X]";
            const valorFinal = parseFloat(p.valorConsulta || 0);
            const totalExtenso = window.valorPorExtenso(valorFinal);
            const dataHoje = new Intl.DateTimeFormat('pt-BR', { dateStyle: 'full' }).format(new Date());
            
            const clinic = window.clinicData || {};
            const clinicLogo = clinic.logo || "";

            const win = window.open('', '', 'height=600,width=800');
            win.document.write(`<html><head><style>@page { size: A5 portrait; margin: 0; } body { font-family: sans-serif; display: flex; justify-content: center; padding: 10px; margin: 0; } .recibo-box { width: 100%; max-width: 14cm; padding: 15px; box-sizing: border-box; } .header { display: grid; grid-template-columns: 1fr 1fr 1fr; align-items: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; } .logo-side { text-align: left; } .logo-side img { height: 50px; } .logo-side p { font-size: 9px; font-weight: bold; margin: 5px 0 0 0; } .title-mid { text-align: center; } .title-mid h1 { font-size: 32px; margin: 0; font-weight: 900; letter-spacing: -1px; } .value-side { background: #dfdfdf; border: 2px solid #000; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: bold; gap: 10px; } .main-content { border: 2px solid #000; border-radius: 12px; padding: 15px; margin-bottom: 15px; line-height: 1.8; font-size: 14px; } .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; font-weight: bold; font-size: 12px; } .footer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; } .f-box { border: 2px solid #000; border-radius: 12px; padding: 10px; font-size: 12px; } .signature-box { text-align: center; display: flex; flex-direction: column; justify-content: space-between; position: relative; } .optom-tag { border-top: 1px solid #000; padding-top: 5px; font-size: 10px; font-weight: bold; margin-top: 40px; }</style></head><body><div class="recibo-box"><div class="header"><div class="logo-side">${clinicLogo ? `<img src="${clinicLogo}">` : ''}<p>CNPJ: ${clinic.cnpj || '36.241.757/0002-03'}</p></div><div class="title-mid"><h1>RECIBO</h1></div><div class="value-side"><span>R$</span> <span>${valorFinal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span></div></div><div class="main-content">Recebi (emos) de: <b>${p.nome.toUpperCase()}</b><br>A importância de: <span style="background:#efefef; padding: 0 5px;">${totalExtenso}</span><br>Referente a: <span>Serviços de exame de vista realizado em ${window.formatarDataBR(p.data)}</span><hr style="border:0; border-bottom:1px solid #000;"><div class="checkbox-group"><span>Forma:</span><span>${op1} Espécie</span> <span>${op2} Cartão</span> <span>${op3} PIX</span></div></div><div class="footer-grid"><div class="f-box"><br><b>Emitente:</b> ${clinic.nome || 'Girlanildo Rodrigues'}<br><br><b>CPF:</b> <span style="font-family:monospace; font-size:14px">${clinic.cnpj || '647.549.792-49'}</span></div><div class="f-box signature-box"><div><b>Data:</b> <span>${dataHoje}</span></div><div class="optom-tag">${clinic.registro || 'Optometrista | CBOO: 04.00163-1'}</div></div></div></div></body></html>`);
            win.document.close(); win.print();
        };

        window.imprimirRecibo = (oticaId, nomeOtica) => {
            const fPag = prompt("Escolha a forma de pagamento:\n1 - Dinheiro\n2 - Cart. de Crédito/Débito\n3 - Transferência Bancária/PIX");
            if(fPag === null) return;
            const perOpcao = prompt("Deseja o recibo referente a:\n1 - Mês Inteiro\n2 - Período Específico (ex: 01 a 15)");
            if(perOpcao === null) return;
            let diaInicio = 1, diaFim = 31, subtituloPeriodo = "Mês Inteiro";
            if(perOpcao === "2") {
                const de = prompt("Dia Inicial (ex: 01):", "01");
                const ate = prompt("Dia Final (ex: 15):", "15");
                if(de) diaInicio = parseInt(de);
                if(ate) diaFim = parseInt(ate);
                subtituloPeriodo = `Período do dia ${diaInicio} ao dia ${diaFim}`;
            }
            let op1 = "[ ]", op2 = "[ ]", op3 = "[ ]";
            if(fPag === "1") op1 = "[X]"; else if(fPag === "2") op2 = "[X]"; else if(fPag === "3") op3 = "[X]";
            const mes = document.getElementById('filtro-mes').value;
            let f = pacientes.filter(p => {
                if(p.status !== "Finalizado" || !p.data || !p.data.startsWith(mes)) return false;
                const diaP = parseInt(p.data.split('-')[2]);
                return diaP >= diaInicio && diaP <= diaFim;
            });
            f = (oticaId === "") ? f.filter(p => !p.oticaId || p.oticaId === "") : f.filter(p => p.oticaId === oticaId);
            if(f.length === 0) return alert("Nenhum atendimento finalizado neste período/parâmetro.");
            let total = 0; 
            if (oticaId === "") f.forEach(p => total += parseFloat(p.valorConsulta || 0));
            else { 
                const o = oticas.find(x => x.id === oticaId); 
                total = (o.tipo === 'Diária') ? o.valor : (f.filter(p => p.pago).length * o.valor); 
            }
            const totalExtenso = window.valorPorExtenso(total);
            const dataHoje = new Intl.DateTimeFormat('pt-BR', { dateStyle: 'full' }).format(new Date());
            
            const clinic = window.clinicData || {};
            const clinicLogo = clinic.logo || "";

            const win = window.open('', '', 'height=600,width=800');
            win.document.write('<html><head><style>@page { size: A5 portrait; margin: 0; } body { font-family: sans-serif; display: flex; justify-content: center; padding: 10px; margin: 0; } .recibo-box { width: 100%; max-width: 14cm; padding: 15px; box-sizing: border-box; } .header { display: grid; grid-template-columns: 1fr 1fr 1fr; align-items: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; } .logo-side { text-align: left; } .logo-side img { height: 50px; } .logo-side p { font-size: 9px; font-weight: bold; margin: 5px 0 0 0; } .title-mid { text-align: center; } .title-mid h1 { font-size: 32px; margin: 0; font-weight: 900; letter-spacing: -1px; } .value-side { background: #dfdfdf; border: 2px solid #000; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: bold; gap: 10px; } .main-content { border: 2px solid #000; border-radius: 12px; padding: 15px; margin-bottom: 15px; line-height: 1.8; font-size: 14px; } .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; font-weight: bold; font-size: 12px; } .footer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; } .f-box { border: 2px solid #000; border-radius: 12px; padding: 10px; font-size: 12px; } .signature-box { text-align: center; display: flex; flex-direction: column; justify-content: space-between; position: relative; } .optom-tag { border-top: 1px solid #000; padding-top: 5px; font-size: 10px; font-weight: bold; margin-top: 40px; }</style></head><body><div class="recibo-box"><div class="header"><div class="logo-side">'+ (clinicLogo ? `<img src="${clinicLogo}">` : '') +'<p>CNPJ: '+(clinic.cnpj || '36.241.757/0002-03')+'</p></div><div class="title-mid"><h1>RECIBO</h1></div><div class="value-side"><span>R$</span> <span>'+total.toLocaleString('pt-BR', {minimumFractionDigits: 2})+'</span></div></div><div class="main-content">Recebi (emos) de: ÓTICA '+nomeOtica.toUpperCase()+'<br>A importância de: <span style="background:#efefef;">'+totalExtenso+'</span><br>Referente a: Serviços de exame de vista ('+subtituloPeriodo+') em '+f.length+' pacientes<hr style="border:0; border-bottom:1px solid #000;"><div class="checkbox-group"><span>Forma:</span><span>'+op1+' Espécie</span> <span>'+op2+' Cartão</span> <span>'+op3+' PIX</span></div></div><div class="footer-grid"><div class="f-box"><b><br>Emitente:</b> '+(clinic.nome || 'Girlanildo Rodrigues')+'<br><br><b>CPF/CNPJ:</b> <span style="font-family:monospace; font-size:14px">'+(clinic.cnpj || '647.549.792-49')+'<br></span></div><div class="f-box signature-box"><div><b>Data:</b> '+dataHoje+'</div><div class="optom-tag">'+(clinic.registro || 'Optometrista | CBOO: 04.00163-1')+'</div></div></div></div></body></html>');
            win.document.close(); win.print();
        };

        window.imprimirRelatorioFinanceiro = (oticaId, nomeOtica) => {
            const mes = document.getElementById('filtro-mes').value;
            const perOpcao = prompt("Deseja o relatório financeiro referente a:\n1 - Mês Inteiro\n2 - Período Específico (ex: 01 a 15)");
            if (perOpcao === null) return;
            let diaInicio = 1, diaFim = 31, subtituloPeriodo = "Mês Inteiro";
            if (perOpcao === "2") {
                const de = prompt("Dia Inicial (ex: 01):", "01");
                const ate = prompt("Dia Final (ex: 15):", "15");
                if (de) diaInicio = parseInt(de);
                if (ate) diaFim = parseInt(ate);
                subtituloPeriodo = `Período do dia ${diaInicio} ao dia ${diaFim}`;
            }
            let f = pacientes.filter(p => {
                if(p.status !== "Finalizado" || !p.data || !p.data.startsWith(mes)) return false;
                const diaP = parseInt(p.data.split('-')[2]);
                return diaP >= diaInicio && diaP <= diaFim;
            });
            if (oticaId === "") f = f.filter(p => !p.oticaId || p.oticaId === ""); 
            else f = f.filter(p => p.oticaId === oticaId);
            if(f.length === 0) return alert("A lista atual está vazia para os parâmetros selecionados."); 
            f.sort((a, b) => (a.data + a.hora).localeCompare(b.data + b.hora));
            
            const clinic = window.clinicData || {};
            const clinicLogo = clinic.logo || "";

            let totalPago = 0; let totalPendente = 0; const win = window.open('', '', 'height=700,width=900');
            win.document.write('<html><head><title>Relatório Financeiro</title><style>@page { size: portrait; } body{font-family:sans-serif;padding:30px;color:#333} .header-rep { display: flex; align-items: center; gap: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; } .header-rep img { height: 60px; } table{width:100%;border-collapse:collapse;margin-top:20px} th,td{border:1px solid #ddd;padding:10px;text-align:left;font-size:12px} th{background:#f8fafc;text-transform:uppercase} .summary{margin-top:30px;padding:20px;background:#f1f5f9;border-radius:10px} .total-line{display:flex;justify-content:space-between;margin-bottom:5px;font-weight:bold} .pago{color:#16a34a} .pendente{color:#dc2626}</style></head><body>');
            win.document.write(`<div class="header-rep">${clinicLogo ? `<img src="${clinicLogo}">` : ''} <div><h1>Relatório Financeiro - ${nomeOtica}</h1><p>Mês: ${mes} | <b>${subtituloPeriodo}</b></p></div></div>`);
            win.document.write('<table><thead><tr><th>Data</th><th>Hora</th><th>Paciente</th><th>Status</th><th>Valor</th><th>Pagamento</th></tr></thead><tbody>');
            f.forEach(p => { const val = parseFloat(p.valorConsulta || 0); if(p.pago) totalPago += val; else totalPendente += val; win.document.write(`<tr><td>${window.formatarDataBR(p.data)}</td><td>${p.hora}</td><td>${p.nome}</td><td>${p.status}</td><td>R$ ${val.toFixed(2)}</td><td>${p.pago ? 'Pago' : 'Pendente'}</td></tr>`); });
            win.document.write(`</tbody></table><div class="summary"><div class="total-line pago"><span>Total Recebido:</span> <span>R$ ${totalPago.toFixed(2)}</span></div><div class="total-line pendente"><span>Total Pendente:</span> <span>R$ ${totalPendente.toFixed(2)}</span></div><div class="total-line" style="border-top:1px solid #ccc; padding-top:10px; margin-top:10px; font-size:16px"><span>VALOR TOTAL DO PERÍODO:</span> <span>R$ ${(totalPago + totalPendente).toFixed(2)}</span></div></div></body></html>`);
            win.document.close(); win.print();
        };

        // CÁLCULO FINANCEIRO
        window.calcularFinanceiro = () => { 
            const mes = document.getElementById('filtro-mes').value; const res = document.getElementById('financeiro-resumo'); res.innerHTML = ""; 
            const pMes = pacientes.filter(p => p.data && p.data.startsWith(mes)); const finTotal = pMes.filter(p => p.status === "Finalizado"); 
            let tg = 0; const particulares = finTotal.filter(p => !p.oticaId || p.oticaId === "");
            let rendPart = 0; particulares.filter(p => p.pago).forEach(p => rendPart += parseFloat(p.valorConsulta || 0)); tg += rendPart;
            if(particulares.length > 0) {
                res.innerHTML += `<div class="glass-card p-6 rounded-3xl border-l-4 border-slate-500"><div class="flex justify-between items-start mb-2"><h4 class="text-xl font-bold uppercase text-white">Particulares</h4><div class="flex gap-2"><button onclick="window.imprimirRecibo('', 'Particulares')" title="Recibo" class="text-white/40 hover:text-cyber transition-colors"><i data-lucide="file-text" class="w-5 h-5"></i></button><button onclick="window.imprimirRelatorioFinanceiro('', 'Particulares')" title="Relatório" class="text-white/40 hover:text-medical transition-colors"><i data-lucide="printer" class="w-5 h-5"></i></button></div></div><h3 class="text-2xl font-bold mt-1 italic text-white">R$ ${rendPart.toFixed(2)}</h3><div class="mt-4 text-[20px] font-bold uppercase opacity-50 text-white">Atendidos: ${particulares.length}</div></div>`;
            }
            oticas.forEach(o => { 
                const fO = pMes.filter(p => p.status === "Finalizado" && p.oticaId === o.id); const pO = fO.filter(p => p.pago); 
                let rend = o.tipo === 'Diária' ? (pO.length > 0 ? o.valor : 0) : (pO.length * o.valor); tg += rend; 
                if(fO.length > 0 || o.tipo === 'Diária') {
                    res.innerHTML += `<div class="glass-card p-6 rounded-3xl border-l-4" style="border-color:${o.cor}"><div class="flex justify-between items-start mb-2"><h4 class="text-xl font-bold uppercase text-white">${o.nome}</h4><div class="flex gap-2"><button onclick="window.imprimirRecibo('${o.id}', '${o.nome}')" title="Recibo" class="text-white/40 hover:text-cyber transition-colors"><i data-lucide="file-text" class="w-5 h-5"></i></button><button onclick="window.imprimirRelatorioFinanceiro('${o.id}', '${o.nome}')" title="Relatório" class="text-white/40 hover:text-medical transition-colors"><i data-lucide="printer" class="w-5 h-5"></i></button></div></div><h3 class="text-2xl font-bold mt-1 italic text-white">R$ ${rend.toFixed(2)}</h3><div class="mt-4 text-[20px] font-bold uppercase opacity-50 text-white">Fin: ${fO.length} | Pagos: ${pO.length}</div></div>`; 
                }
            }); 
            document.getElementById('total-global').innerText = `R$ ${tg.toFixed(2)}`; 
            document.getElementById('prod-total').innerText = finTotal.length; 
            lucide.createIcons();
        };

        // FILTROS E BUSCAS
        window.filtrarBuscaAgenda = (v) => { filtroBuscaAgenda = v.toLowerCase(); renderAgenda(); };
        window.limparBuscaAgenda = () => { filtroBuscaAgenda = ""; document.getElementById('search-agenda').value = ""; renderAgenda(); };
        window.filtrarStatus = (st) => { filtroStatus = st; document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active')); document.getElementById('btn-' + st).classList.add('active'); const cal = document.getElementById('cal-agendado'); if(st === 'Agendado') cal.classList.remove('hidden'); else { cal.classList.add('hidden'); filtroDataAgendado = ""; } renderAgenda(); };
        window.selecionarDataAgendado = (val) => { filtroDataAgendado = val; renderAgenda(); };
        window.filtrarPorOtica = (id) => { filtroOtica = id; renderAgenda(); };
        window.filtrarPorPagamento = (val) => { filtroPagoAgenda = val; renderAgenda(); };
        window.filtrarPorMesAgenda = (val) => { filtroMesAgenda = val; renderAgenda(); };
        window.filtrarBuscaPaciente = (v) => { filtroBuscaPaciente = v.toLowerCase(); renderDatabasePacientes(); };
        window.limparBuscaPaciente = () => { filtroBuscaPaciente = ""; document.getElementById('search-paciente').value = ""; renderDatabasePacientes(); };
        window.limparFiltros = () => { 
            filtroStatus = "Todos"; 
            filtroOtica = ""; 
            filtroPagoAgenda = "Todos";
            filtroMesAgenda = ""; 
            filtroDataAgendado = ""; 
            filtroBuscaAgenda = ""; 
            document.getElementById('filtro-otica-agenda').value = ""; 
            document.getElementById('filtro-pago-agenda').value = "Todos"; 
            document.getElementById('filtro-mes-agenda').value = ""; 
            document.getElementById('search-agenda').value = ""; 
            document.getElementById('cal-agendado').classList.add('hidden'); 
            window.filtrarStatus('Todos'); 
        };
        
        // OBSERVADORES DATABASE
        onSnapshot(collection(db, "oticas"), (snap) => { 
            oticas = snap.docs.map(d => ({id: d.id, ...d.data()})); 
            const s1 = document.getElementById('p-otica'), s2 = document.getElementById('filtro-otica-agenda'); 
            s1.innerHTML = '<option value="">Particular</option>'; 
            s2.innerHTML = '<option value="">Ótica</option>'; 
            oticas.forEach(o => { 
                s1.innerHTML += `<option value="${o.id}">${o.nome}</option>`; 
                s2.innerHTML += `<option value="${o.id}">${o.nome}</option>`; 
            }); 
            renderOticas(); 
        });
        
        window.processarAniversariante = (id) => {
            window.anivSendoProcessado = id; 
            window.openDisparo(id); 
        };

        window.verificarAniversariantes = (lista) => {
            if (window.bdayNotified || !auth.currentUser) return; 
            const hoje = new Date();
            const diaHoje = hoje.getDate();
            const mesHoje = hoje.getMonth() + 1;

            const niverHoje = lista.filter(p => {
                if (!p.nascimento) return false;
                const partes = p.nascimento.split('-');
                const mesNasc = parseInt(partes[1]);
                const diaNasc = parseInt(partes[2]);
                return diaNasc === diaHoje && mesNasc === mesHoje;
            });

            if (niverHoje.length > 0) {
                const listContainer = document.getElementById('lista-aniversariantes-modal');
                const dateDisplay = document.getElementById('bday-date-display');
                listContainer.innerHTML = "";
                dateDisplay.innerText = new Intl.DateTimeFormat('pt-BR', { dateStyle: 'long' }).format(hoje);

                niverHoje.forEach(p => {
                    listContainer.innerHTML += `
                        <div id="bday-card-${p.id}" class="flex items-center justify-between bg-white/5 p-4 rounded-2xl border border-white/5 hover:bg-white/10 transition-all cursor-pointer" onclick="window.processarAniversariante('${p.id}')">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 bg-medical/20 rounded-full flex items-center justify-center text-medical font-bold">
                                    <i data-lucide="user" class="w-5 h-5"></i>
                                </div>
                                <div class="text-left">
                                    <p class="text-xs font-black text-white uppercase">${p.nome || 'SEM NOME'}</p>
                                    <p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">${p.tel || 'S/ WHATSAPP'}</p>
                                    <p class="text-[11px] text-medical font-black uppercase tracking-normal mt-1">${p.oticaNome || 'PARTICULAR'}</p>
                                </div>
                            </div>
                            <div class="p-3 bg-medical/20 text-medical rounded-xl">
                                <i data-lucide="send" class="w-4 h-4"></i>
                            </div>
                        </div>
                    `;
                });

                setTimeout(() => {
                    window.openModal('modal-aniversariantes');
                    lucide.createIcons();
                }, 1000);
            }
            window.bdayNotified = true;
        };

        onSnapshot(collection(db, "pacientes"), (snap) => { 
            pacientes = snap.docs.map(d => ({id: d.id, ...d.data()})); 
            renderAgenda(); 
            renderDatabasePacientes(); 
            calcularFinanceiro(); 
            if(auth.currentUser) window.verificarAniversariantes(pacientes);
        });

        onSnapshot(collection(db, "templates"), (snap) => { templates = snap.docs.map(d => ({id: d.id, ...d.data()})); renderTemplates(); });
        
        // RENDERIZAÇÃO DE TELAS
        function renderAgenda() { 
            const lista = document.getElementById('lista-agenda'); 
            lista.innerHTML = ""; 
            let f = pacientes; 
            if (filtroBuscaAgenda !== "") {
                f = f.filter(p => 
                    (p.nome && p.nome.toLowerCase().includes(filtroBuscaAgenda)) || 
                    (p.cpf && p.cpf.replace(/\D/g,"").includes(filtroBuscaAgenda.replace(/\D/g,"")))
                );
            }
            if (filtroStatus === "Agendado" && filtroDataAgendado !== "") f = f.filter(p => p.status === "Agendado" && p.data === filtroDataAgendado); 
            else if (filtroStatus !== "Todos") f = f.filter(p => p.status === filtroStatus); 
            if (filtroOtica !== "") f = f.filter(p => p.oticaId === filtroOtica); 
            if (filtroPagoAgenda !== "Todos") {
                const isPago = filtroPagoAgenda === "Pago";
                f = f.filter(p => p.pago === isPago);
            }
            if (filtroMesAgenda !== "") f = f.filter(p => p.data && p.data.startsWith(filtroMesAgenda)); 
            document.getElementById('resumo-atendidos-agenda').innerText = f.filter(p => p.status === "Finalizado").length; 
            if(f.length === 0) lista.innerHTML = '<tr><td colspan="6" class="p-6 text-center opacity-30 text-xs">Nenhum registro.</td></tr>'; 
            f.forEach(p => { 
                const stL = (p.status || "Agendado").toLowerCase().replace("ç", "c"); 
                lista.innerHTML += `<tr class="hover:bg-white/5 transition-all"><td class="py-2 px-6 text-[10px] whitespace-nowrap"><b>${window.formatarDataBR(p.data)}</b> <br> ${p.hora}</td><td class="py-2 px-6 font-bold text-xs uppercase text-white whitespace-nowrap cursor-pointer hover:text-medical" onclick="window.viewPaciente('${p.id}')">${p.nome}</td><td class="py-2 px-6 whitespace-nowrap"><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full" style="background:${p.oticaCor}"></div><span class="text-[9px] uppercase font-bold text-slate-400">${p.oticaNome}</span></div></td><td class="py-2 px-6"><select onchange="window.changeStatus('${p.id}', this.value)" class="status-pill st-${stL} outline-none"><option value="Agendado" ${p.status === 'Agendado' ? 'selected' : ''}>Agendado</option><option value="Recepção" ${p.status === 'Recepção' ? 'selected' : ''}>Recepção</option><option value="Consulta" ${p.status === 'Consulta' ? 'selected' : ''}>Consulta</option><option value="Finalizado" ${p.status === 'Finalizado' ? 'selected' : ''}>Finalizado</option></select></td><td class="py-2 px-6 text-center"><button onclick="window.togglePago('${p.id}', ${p.pago})" class="p-2"><i data-lucide="${p.pago ? 'check-circle' : 'clock'}" class="${p.pago ? 'text-green-500' : 'opacity-20'} w-4 mx-auto"></i></button></td><td class="py-2 px-6 text-right space-x-1 whitespace-nowrap"><button onclick="window.editPaciente('${p.id}')" class="p-2 hover:text-medical text-white"><i data-lucide="edit-3" class="w-4 h-4"></i></button><button onclick="window.openDisparo('${p.id}')" class="p-2 text-medical"><i data-lucide="send" class="w-4 h-4"></i></button><button onclick="window.imprimirReceita('${p.id}')" title="Imprimir Receita" class="p-2 text-green-400"><i data-lucide="clipboard-list" class="w-4 h-4"></i></button><button onclick="window.imprimirReciboIndividual('${p.id}')" title="Imprimir Recibo Individual" class="p-2 text-cyber"><i data-lucide="printer" class="w-4 h-4"></i></button><button onclick="window.apagar('pacientes', '${p.id}')" class="p-2 text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`; 
            }); 
            lucide.createIcons(); 
        }

        window.getStatusVencimento = (ultimoExame) => {
            if(!ultimoExame) return "";
            try {
                const dataExame = new Date(ultimoExame + "T00:00:00");
                const hoje = new Date();
                const diffTime = hoje - dataExame;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays >= 365) return `<span class="mt-1 inline-block px-2 py-0.5 rounded bg-red-500/20 text-red-500 text-[10px] font-black border border-red-500/50">VENCIDO</span>`;
                else if (diffDays >= 335) return `<span class="mt-1 inline-block px-2 py-0.5 rounded bg-orange-500/20 text-orange-400 text-[10px] font-black border border-orange-500/50">VENCE EM ${365 - diffDays} DIAS</span>`;
                else return `<span class="mt-1 inline-block text-[10px] text-slate-500 opacity-50">VENCE EM ${365 - diffDays}D</span>`;
            } catch(e) { return ""; }
        }

        window.getAniversarioInfo = (nascimento) => {
            if (!nascimento) return { isToday: false, text: "" };
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const partes = nascimento.split('-');
            if(partes.length !== 3) return { isToday: false, text: "" };
            const mesNasc = parseInt(partes[1]) - 1;
            const diaNasc = parseInt(partes[2]);
            let proxBday = new Date(hoje.getFullYear(), mesNasc, diaNasc);
            if (proxBday < hoje) proxBday.setFullYear(hoje.getFullYear() + 1);
            const diffTime = proxBday - hoje;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const eHoje = (hoje.getDate() === diaNasc && hoje.getMonth() === mesNasc);
            if (eHoje) return { isToday: true, text: "🎂 ANIVERSÁRIO HOJE!" };
            return { isToday: false, text: `🎂 Faltam ${diffDays} dias` };
        }

        function renderDatabasePacientes() { 
            const lista = document.getElementById('lista-db-pacientes'); 
            lista.innerHTML = ""; 
            let f = pacientes; 
            if(filtroBuscaPaciente !== "") f = f.filter(p => p.nome && p.nome.toLowerCase().includes(filtroBuscaPaciente)); 
            const baseUnica = Array.from(new Map(f.map(p => [p.nome, p])).values()); 
            baseUnica.forEach(p => { 
                const badgeVencimento = window.getStatusVencimento(p.ultimoExame || p.data);
                const bday = window.getAniversarioInfo(p.nascimento);
                const classeAniv = bday.isToday ? "bday-today" : "";
                lista.innerHTML += `<tr class="hover:bg-white/5 transition-all text-white"><td class="py-3 px-6 font-bold text-xs uppercase whitespace-nowrap flex items-center cursor-pointer hover:text-medical ${classeAniv}" onclick="window.viewPaciente('${p.id}')">${p.nome}</td><td class="py-3 px-6 text-[10px] whitespace-nowrap">${p.idadeText || 'N/A'} <br><span class="text-cyber opacity-80 font-bold">${bday.text}</span></td><td class="py-3 px-6 font-mono text-[10px] whitespace-nowrap">${p.tel}</td><td class="py-3 px-6 text-[10px] whitespace-nowrap">${window.formatarDataBR(p.ultimoExame || p.data) || 'N/A'} <br>${badgeVencimento}</td><td class="py-3 px-6 text-right space-x-2 whitespace-nowrap"><button onclick="window.editPaciente('${p.id}')" class="p-2 hover:text-medical text-white"><i data-lucide="edit-3" class="w-4"></i></button><button onclick="window.openDisparo('${p.id}')" class="p-2 text-medical"><i data-lucide="send" class="w-4"></i></button></td></tr>`; 
            }); 
            lucide.createIcons(); 
        }

        function renderOticas() { const g = document.getElementById('grid-oticas'); g.innerHTML = ""; oticas.forEach(o => { g.innerHTML += `<div class="glass-card p-4 rounded-2xl border-t-4 group" style="border-color:${o.cor}"><div class="flex justify-between font-bold text-xs text-white"><h4>${o.nome}</h4><div class="flex gap-2"><button onclick="window.editOtica('${o.id}')" class="text-medical p-2"><i data-lucide="edit-3" class="w-4"></i></button><button onclick="window.apagar('oticas', '${o.id}')" class="text-red-500 p-2"><i data-lucide="trash" class="w-4"></i></button></div></div><p class="text-[9px] opacity-50 uppercase text-white">${o.tipo}</p><h3 class="text-xl font-bold mt-2 text-white">R$ ${o.valor.toFixed(2)}</h3></div>`; }); lucide.createIcons(); }
        function renderTemplates() { const g = document.getElementById('grid-templates'); g.innerHTML = ""; templates.forEach(t => { g.innerHTML += `<div class="glass-card p-4 rounded-2xl group"><div class="flex justify-between font-bold text-xs text-white mb-2"><h4 class="text-medical uppercase tracking-tighter">${t.titulo}</h4><div class="flex gap-2"><button onclick="window.editTemplate('${t.id}')" class="text-medical p-2"><i data-lucide="edit-3" class="w-4"></i></button><button onclick="window.apagar('templates', '${t.id}')" class="text-red-500 p-2"><i data-lucide="trash-2" class="w-4"></i></button></div></div><p class="text-[10px] text-slate-400 line-clamp-3 mb-2">${t.texto}</p></div>`; }); lucide.createIcons(); }
        
        window.togglePatientFields = (readonly) => {
            const inputs = document.getElementById('aba-cadastro').querySelectorAll('input, select, textarea');
            inputs.forEach(el => el.disabled = readonly);
            const btnSalvar = document.getElementById('btn-salvar-paciente');
            const btnEditar = document.getElementById('btn-habilitar-edicao');
            const btnNovoProntuario = document.getElementById('btn-cadastrar-prontuario');
            if (readonly) {
                btnSalvar.classList.add('hidden');
                btnEditar.classList.remove('hidden');
                btnNovoProntuario.classList.add('hidden');
            } else {
                btnSalvar.classList.remove('hidden');
                btnEditar.classList.add('hidden');
                btnNovoProntuario.classList.remove('hidden');
            }
        };

        // GESTÃO DE DADOS
        window.enablePatientEdit = () => { window.togglePatientFields(false); document.getElementById('title-paciente').innerText = "Editando Paciente"; };
        window.viewPaciente = (id) => { window.editPaciente(id); window.togglePatientFields(true); document.getElementById('title-paciente').innerText = "Visualizando Paciente"; };
        window.editPaciente = (id) => { const p = pacientes.find(i => i.id === id); editPId = id; document.getElementById('p-nome').value = p.nome || ""; document.getElementById('p-tel').value = p.tel || ""; document.getElementById('p-data-agenda').value = p.data || ""; document.getElementById('p-hora').value = p.hora || ""; document.getElementById('p-status-modal').value = p.status || "Recepção"; document.getElementById('p-pago-modal').value = p.pago ? "Pago" : "Pendente"; document.getElementById('p-otica').value = p.oticaId || ""; document.getElementById('p-sexo').value = p.sexo || "M"; document.getElementById('p-nascimento').value = p.nascimento || ""; document.getElementById('p-cpf').value = p.cpf || ""; window.updateAge(p.nascimento); document.getElementById('p-origem').value = p.origem || ""; document.getElementById('p-profissao').value = p.profissao || ""; document.getElementById('p-passatempo').value = p.passatempo || ""; document.getElementById('p-endereco').value = p.endereco || ""; document.getElementById('p-ultimo-exame').value = p.ultimoExame || ""; document.getElementById('p-ajuda').value = p.ajuda || ""; document.getElementById('p-responsavel').value = p.responsavel || ""; window.togglePatientFields(false); document.getElementById('title-paciente').innerText = "Editar Paciente"; window.openModal('modal-paciente'); };
        window.editOtica = (id) => { const o = oticas.find(i => i.id === id); editOId = id; document.getElementById('ot-nome').value = o.nome; document.getElementById('ot-tipo').value = o.tipo; document.getElementById('ot-valor').value = o.valor; document.getElementById('ot-cor').value = o.cor; document.getElementById('title-otica').innerText = "Editar Ótica"; window.openModal('modal-otica'); };
        window.saveOtica = async () => { const data = { nome: document.getElementById('ot-nome').value, tipo: document.getElementById('ot-tipo').value, valor: parseFloat(document.getElementById('ot-valor').value || 0), cor: document.getElementById('ot-cor').value }; if(editOId) await updateDoc(doc(db, "oticas", editOId), data); else await addDoc(collection(db, "oticas"), data); window.closeModal('modal-otica'); };
        window.editTemplate = (id) => { const t = templates.find(i => i.id === id); editTId = id; document.getElementById('t-titulo').value = t.titulo; document.getElementById('t-texto').value = t.texto; document.getElementById('title-template').innerText = "Editar Template"; window.openModal('modal-template'); };
        window.saveTemplate = async () => { const data = { titulo: document.getElementById('t-titulo').value, texto: document.getElementById('t-texto').value }; if(editTId) await updateDoc(doc(db, "templates", editTId), data); else await addDoc(collection(db, "templates"), { ...data, created: Date.now() }); window.closeModal('modal-template'); };
        
        // DISPARO WHATSAPP
        window.openDisparo = (id) => { 
            const p = pacientes.find(i => i.id === id); 
            if(!p) return;
            document.getElementById('target-name').innerText = p.nome; 
            const list = document.getElementById('pick-list'); 
            list.innerHTML = ""; 
            templates.forEach(t => { 
                const btn = document.createElement('button'); 
                btn.className = "w-full p-4 bg-white/5 rounded-2xl hover:bg-medical/10 text-left font-bold text-sm border border-white/5 text-white"; 
                btn.innerText = t.titulo; 
                btn.onclick = () => {
                    let msg = t.texto
                        .replace(/{{nome}}/g, p.nome)
                        .replace(/{{otica}}/g, p.oticaNome || "Particular")
                        .replace(/{{data}}/g, window.formatarDataBR(p.data) || "")
                        .replace(/{{hora}}/g, p.hora || "")
                        .replace(/{{ultimo_exame}}/g, window.formatarDataBR(p.ultimoExame) || "Não informado");
                    window.open(`https://wa.me/55${p.tel.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, "_blank");
                    
                    if(window.anivSendoProcessado) {
                        const card = document.getElementById(`bday-card-${window.anivSendoProcessado}`);
                        if(card) card.remove();
                        window.anivSendoProcessado = null; 
                        const listaAniv = document.getElementById('lista-aniversariantes-modal');
                        if(listaAniv.children.length === 0) window.closeModal('modal-aniversariantes');
                    }
                    window.closeModal('modal-pick');
                };
                list.appendChild(btn); 
            }); 
            window.openModal('modal-pick'); 
        };

        window.apagar = async (col, id) => {  if(userPermissions.lockDelete && !userPermissions.isAdmin) return alert("Você não tem permissão para excluir.");

    if(confirm("Confirmar exclusão?")) { 
        await deleteDoc(doc(db, col, id)); 
        if(col === 'historicos') renderHistoricoCompleto(); 
        if(col === 'usuarios') renderListaUsuarios(); // Adicione essa linha também
    } 
};
        window.changeStatus = async (id, val) => { await updateDoc(doc(db, "pacientes", id), { status: val }); };
        window.togglePago = async (id, current) => { await updateDoc(doc(db, "pacientes", id), { pago: !current }); };
        lucide.createIcons();


 













// Aplica o bloqueio visual nos menus e botões
window.applyPermissions = () => {
    if(userPermissions.isAdmin) return;

    if(userPermissions.hideFinance) document.querySelector('[onclick="nav(\'financeiro\')"]')?.classList.add('hidden');
    if(userPermissions.hidePatients) document.querySelector('[onclick="nav(\'pacientes-db\')"]')?.classList.add('hidden');
    if(userPermissions.hideOticas) document.querySelector('[onclick="nav(\'oticas\')"]')?.classList.add('hidden');
    if(userPermissions.hideTemplates) document.querySelector('[onclick="nav(\'templates\')"]')?.classList.add('hidden');
    if(userPermissions.hideConfig) document.querySelector('[onclick="nav(\'configuracoes\')"]')?.classList.add('hidden');
    
    // Bloqueia botão de novo exame se 'lockExams' for true
    if(userPermissions.lockExams) document.getElementById('btn-cadastrar-prontuario')?.classList.add('hidden');
};

// Abre o painel (somente Admin ou quem tem acesso a config)
window.acessarPainelRestricoes = () => {
    if(!userPermissions.isAdmin) return alert("Acesso negado.");
    window.openModal('modal-restricoes');
    window.renderListaUsuarios();
};








// Renderiza a lista de funcionários com os switches de permissão
window.renderListaUsuarios = async () => {
    const lista = document.getElementById('lista-usuarios-sistema');
    if (!lista) return;
    lista.innerHTML = "<tr><td colspan='9' class='p-10 text-center animate-pulse'>Carregando usuários...</td></tr>";
    
    try {
        const snap = await getDocs(collection(db, "usuarios"));
        lista.innerHTML = "";
        
        snap.forEach(uDoc => {
            const u = uDoc.data();
            const isUserAdmin = u.isAdmin === true;

            lista.innerHTML += `
                <tr class="hover:bg-white/5 border-b border-white/5 text-xs text-white">
                    <td class="py-4 px-6 font-bold">
                        ${u.email} ${isUserAdmin ? '<br><span class="text-[8px] text-cyber">[ADMINISTRADOR]</span>' : ''}
                    </td>
                    
                    <td class="py-4 px-6 text-center">
                        <label class="switch">
                            <input type="checkbox" onchange="window.updateUserPerm('${uDoc.id}', 'lockDelete', this.checked)" ${u.lockDelete ? 'checked' : ''} ${isUserAdmin ? 'disabled' : ''}>
                            <span class="slider"></span>
                        </label>
                    </td>
                    
                    <td class="py-4 px-6 text-center">
                        <label class="switch">
                            <input type="checkbox" onchange="window.updateUserPerm('${uDoc.id}', 'hideFinance', this.checked)" ${u.hideFinance ? 'checked' : ''} ${isUserAdmin ? 'disabled' : ''}>
                            <span class="slider"></span>
                        </label>
                    </td>
                    
                    <td class="py-4 px-6 text-center">
                        <label class="switch">
                            <input type="checkbox" onchange="window.updateUserPerm('${uDoc.id}', 'lockExams', this.checked)" ${u.lockExams ? 'checked' : ''} ${isUserAdmin ? 'disabled' : ''}>
                            <span class="slider"></span>
                        </label>
                    </td>
                    
                    <td class="py-4 px-6 text-center">
                        <label class="switch">
                            <input type="checkbox" onchange="window.updateUserPerm('${uDoc.id}', 'hidePatients', this.checked)" ${u.hidePatients ? 'checked' : ''} ${isUserAdmin ? 'disabled' : ''}>
                            <span class="slider"></span>
                        </label>
                    </td>
                    
                    <td class="py-4 px-6 text-center">
                        <label class="switch">
                            <input type="checkbox" onchange="window.updateUserPerm('${uDoc.id}', 'hideOticas', this.checked)" ${u.hideOticas ? 'checked' : ''} ${isUserAdmin ? 'disabled' : ''}>
                            <span class="slider"></span>
                        </label>
                    </td>
                    
                    <td class="py-4 px-6 text-center">
                        <label class="switch">
                            <input type="checkbox" onchange="window.updateUserPerm('${uDoc.id}', 'hideTemplates', this.checked)" ${u.hideTemplates ? 'checked' : ''} ${isUserAdmin ? 'disabled' : ''}>
                            <span class="slider"></span>
                        </label>
                    </td>
                    
                    <td class="py-4 px-6 text-center">
                        <label class="switch">
                            <input type="checkbox" onchange="window.updateUserPerm('${uDoc.id}', 'hideConfig', this.checked)" ${u.hideConfig ? 'checked' : ''} ${isUserAdmin ? 'disabled' : ''}>
                            <span class="slider"></span>
                        </label>
                    </td>

                    <td class="py-4 px-6 text-right">
                        ${isUserAdmin ? '-' : `<button onclick="window.apagar('usuarios', '${uDoc.id}')" class="text-red-500 hover:text-red-400 font-bold uppercase text-[9px]">Excluir</button>`}
                    </td>
                </tr>`;
        });
        lucide.createIcons();
    } catch (e) {
        lista.innerHTML = `<tr><td colspan='9' class='p-10 text-center text-red-500'>Erro ao carregar: ${e.message}</td></tr>`;
    }
};








// Salva a alteração do switch direto no banco
window.updateUserPerm = async (uid, field, value) => {
    const update = {}; update[field] = value;
    await updateDoc(doc(db, "usuarios", uid), update);
};

// Cria o novo usuário no Firebase Auth e no Firestore
window.saveNewUser = async () => {
    const email = document.getElementById('new-user-email').value;
    const pass = document.getElementById('new-user-pass').value;
    try {
        const userCred = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db, "usuarios", userCred.user.uid), {
            email: email, 
            uid: userCred.user.uid,
            isAdmin: false, // Todo novo usuário começa sem poder de admin
            lockDelete: true, 
            hideFinance: true, 
            // ... outras restrições padrão
        });
        alert("Usuário criado com sucesso!");
        window.closeModal('modal-novo-usuario');
        window.renderListaUsuarios();
    } catch (e) { alert("Erro: " + e.message); }
};








    </script>

    <!-- SEGURANÇA E BLOQUEIOS -->
    <script>
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => {
            const cp = "512959"; if (e.key === 'F12') { e.preventDefault(); if (prompt("Senha:") !== cp) return false; }
            if ((e.ctrlKey || e.metaKey) && (['s','u','p'].includes(e.key.toLowerCase()))) { e.preventDefault(); return false; }
        });
    </script>
</body>
</html>