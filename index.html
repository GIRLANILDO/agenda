<!DOCTYPE html>
<html lang="pt-br" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NexGen Health | Sistema Optométrico Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { medical: '#0ea5e9', cyber: '#22d3ee', darkBg: '#020617', surface: '#0f172a' }, fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] } } }
        }
    </script>
    <style>
        :root { color-scheme: dark; }
        body { overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .dark .glass-card { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255, 255, 255, 0.05); }
        .btn-medical { background: linear-gradient(135deg, #0ea5e9 0%, #22d3ee 100%); transition: all 0.3s; color: #fff; font-weight: 700; min-height: 44px; }
        .input-clinical { background: #1e293b; border: 1px solid rgba(255, 255, 255, 0.1); color: white; border-radius: 10px; padding: 0.75rem; width: 100%; outline: none; min-height: 44px; }
        .status-pill { padding: 6px 10px; border-radius: 6px; font-size: 10px; font-weight: 800; text-transform: uppercase; border: none; cursor: pointer; color: white; min-height: 32px; }
        .st-agendado { background: #475569; } .st-recepcao { background: #ca8a04; } .st-consulta { background: #7c3aed; } .st-finalizado { background: #16a34a; }
        .filter-btn { transition: all 0.3s; border: 1px solid rgba(255,255,255,0.05); color: #94a3b8; font-size: 10px; font-weight: bold; padding: 10px 16px; border-radius: 8px; text-transform: uppercase; cursor: pointer; min-height: 44px; }
        .filter-btn.active { background-color: #0ea5e9; color: white; border-color: #0ea5e9; box-shadow: 0 0 15px rgba(14, 165, 233, 0.3); }
        .rx-table th { background: rgba(14, 165, 233, 0.2); font-size: 10px; padding: 8px 5px; border: 1px solid rgba(255,255,255,0.1); color: #22d3ee; }
        .rx-table td { border: 1px solid rgba(255,255,255,0.1); }
        .rx-table input { background: transparent; border: none; width: 100%; text-align: center; padding: 10px 5px; color: white; outline: none; min-height: 44px; }
        select option { background-color: #0f172a !important; color: white !important; }
        .nav-item.active { background: rgba(14, 165, 233, 0.1); color: #0ea5e9; border-right: 3px solid #0ea5e9; border-radius: 0; }
        .tab-btn.active { border-bottom: 2px solid #0ea5e9; color: #0ea5e9; }
        
        /* Mobile Sidebar Toggle */
        #sidebar { transition: transform 0.3s ease-in-out; }
        @media (max-width: 1024px) {
            #sidebar { transform: translateX(-100%); }
            #sidebar.open { transform: translateX(0); }
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-darkBg text-slate-800 dark:text-slate-200 min-h-screen">

    <!-- BOTÃO MENU MOBILE -->
    <header class="lg:hidden fixed top-0 left-0 right-0 h-16 glass z-[60] flex items-center px-4 justify-between">
        <img src="Logo Girlanildo Branco.png" alt="Logo" class="h-8 object-contain">
        <button onclick="toggleSidebar()" class="p-2 text-white bg-medical rounded-lg">
            <i data-lucide="menu"></i>
        </button>
    </header>

    <aside id="sidebar" class="fixed left-0 top-0 h-full w-64 glass border-r border-white/5 z-[70] flex flex-col">
        <div class="p-8 hidden lg:flex items-center gap-4">
            <img src="Logo Girlanildo Branco.png" alt="Logo" class="w-full h-auto object-contain">
        </div>
        <nav class="flex-1 space-y-1 mt-20 lg:mt-0" id="sidebar-nav">
            <button onclick="nav('agenda')" class="nav-item active w-full flex items-center gap-4 p-4 hover:bg-white/5 transition-all"><i data-lucide="calendar"></i> <span class="font-semibold">Agenda</span></button>
            <button onclick="nav('pacientes-db')" class="nav-item w-full flex items-center gap-4 p-4 hover:bg-white/5 transition-all"><i data-lucide="users"></i> <span class="font-semibold">Pacientes</span></button>
            <button onclick="nav('oticas')" class="nav-item w-full flex items-center gap-4 p-4 hover:bg-white/5 transition-all"><i data-lucide="store"></i> <span class="font-semibold">Óticas Parceiras</span></button>
            <button onclick="nav('templates')" class="nav-item w-full flex items-center gap-4 p-4 hover:bg-white/5 transition-all"><i data-lucide="message-square"></i> <span class="font-semibold">Mensagens</span></button>
            <button onclick="nav('financeiro')" class="nav-item w-full flex items-center gap-4 p-4 hover:bg-white/5 transition-all"><i data-lucide="bar-chart-3"></i> <span class="font-semibold">Relatório</span></button>
        </nav>
        <!-- Overlay para fechar no mobile -->
        <div onclick="toggleSidebar()" class="lg:hidden absolute top-4 right-4 text-white p-2">
            <i data-lucide="x"></i>
        </div>
    </aside>

    <main class="lg:ml-64 p-4 md:p-8 lg:p-12 pt-24 lg:pt-12">
        
        <!-- SECÇÃO AGENDA -->
        <div id="sec-agenda" class="content-sec">
            <div class="flex flex-col md:flex-row justify-between items-start gap-6 mb-10">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold uppercase italic text-white">Agenda <span class="text-medical">Optométrica</span></h1>
                    <p id="display-date" class="text-slate-500 font-mono mt-2 uppercase text-[10px] tracking-widest"></p>
                </div>
                <div class="flex flex-col items-start md:items-end w-full md:w-auto">
                    <button onclick="window.openModalCadastro('paciente')" class="btn-medical w-full md:w-auto px-6 py-3 rounded-xl flex items-center justify-center gap-2 text-white">
                        <i data-lucide="plus"></i> NOVO AGENDAMENTO
                    </button>
                    <div class="mt-4 text-left md:text-right">
                        <span class="text-[10px] uppercase font-bold text-slate-500 tracking-widest block">Atendidos no período</span>
                        <span id="resumo-atendidos-agenda" class="text-3xl font-black text-medical italic leading-none">0</span>
                    </div>
                </div>
            </div>

            <!-- FILTROS -->
            <div class="flex flex-wrap gap-2 mb-8 items-center">
                <button onclick="window.filtrarStatus('Todos')" class="filter-btn active" id="btn-Todos">Todos</button>
                <div class="flex items-center gap-2">
                    <button onclick="window.filtrarStatus('Agendado')" class="filter-btn bg-white/5" id="btn-Agendado">Agendados</button>
                    <input type="date" id="cal-agendado" onchange="window.selecionarDataAgendado(this.value)" class="hidden bg-white/5 border border-white/10 px-3 py-1.5 rounded-lg text-xs outline-none text-white min-h-[44px]">
                </div>
                <button onclick="window.filtrarStatus('Recepção')" class="filter-btn bg-white/5" id="btn-Recepção">Recepção</button>
                <button onclick="window.filtrarStatus('Consulta')" class="filter-btn bg-white/5" id="btn-Consulta">Consulta</button>
                <button onclick="window.filtrarStatus('Finalizado')" class="filter-btn bg-white/5" id="btn-Finalizado">Finalizados</button>
                
                <div class="flex flex-1 gap-2 min-w-full md:min-w-0 mt-2 md:mt-0">
                    <select id="filtro-otica-agenda" onchange="window.filtrarPorOtica(this.value)" class="bg-white/5 border border-white/10 px-4 py-2 rounded-lg text-xs uppercase outline-none text-white flex-1 md:w-40 min-h-[44px]"></select>
                    <input type="month" id="filtro-mes-agenda" onchange="window.filtrarPorMesAgenda(this.value)" class="bg-white/5 border border-white/10 px-4 py-2 rounded-lg text-xs uppercase outline-none text-white flex-1 md:w-40 min-h-[44px]">
                </div>
                <button onclick="window.limparFiltros()" class="text-red-500 text-[10px] font-bold uppercase py-2">Limpar Tudo</button>
            </div>

            <!-- TABELA AGENDA -->
            <div class="glass-card rounded-[1.5rem] md:rounded-[2rem] overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[700px]">
                        <thead class="bg-white/5 text-[10px] uppercase tracking-widest opacity-50">
                            <tr><th class="py-4 px-6 text-white">Data/Hora</th><th class="py-4 px-6 text-white">Paciente</th><th class="py-4 px-6 text-white">Ótica</th><th class="py-4 px-6 text-white">Status</th><th class="py-4 px-6 text-center text-white">Pago</th><th class="py-4 px-6 text-right text-white">Ações</th></tr>
                        </thead>
                        <tbody id="lista-agenda" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- OUTRAS SEÇÕES (PACIENTES, FINANCEIRO, ETC) -->
        <div id="sec-pacientes-db" class="hidden content-sec">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 mb-10">
                <h1 class="text-3xl md:text-4xl font-bold uppercase italic text-white">Pacientes</h1>
                <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                    <input type="text" id="search-paciente" oninput="window.filtrarBuscaPaciente(this.value)" placeholder="Buscar por nome..." class="bg-surface border border-white/10 p-3 rounded-xl outline-none flex-1 md:w-64 min-h-[44px] text-white">
                    <button onclick="window.limparBuscaPaciente()" class="bg-white/5 px-6 py-3 rounded-xl font-bold uppercase text-[10px] min-h-[44px] text-white">Limpar</button>
                </div>
            </div>
            <div class="glass-card rounded-[1.5rem] md:rounded-[2rem] overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[600px]">
                        <thead class="bg-white/5 text-[9px] uppercase tracking-widest opacity-50">
                            <tr><th class="py-4 px-6 text-white">Nome</th><th class="py-4 px-6 text-white">Idade</th><th class="py-4 px-6 text-white">WhatsApp</th><th class="py-4 px-6 text-white">Data do Exame</th><th class="py-4 px-6 text-right text-white">Ações</th></tr>
                        </thead>
                        <tbody id="lista-db-pacientes" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="sec-financeiro" class="hidden content-sec">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 mb-10">
                <h2 class="text-3xl md:text-4xl font-bold text-white uppercase italic">Financeiro</h2>
                <input type="month" id="filtro-mes" onchange="window.calcularFinanceiro()" class="input-clinical !w-full md:!w-auto">
            </div>
            <div id="resumo-cards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 md:gap-6 mb-8 text-center text-white font-bold">
                <div class="glass-card p-6 rounded-2xl border-b-4 border-green-500">
                    <p class="text-[10px] uppercase opacity-50">Global</p>
                    <h3 class="text-2xl md:text-3xl" id="total-global">R$ 0,00</h3>
                </div>
                <div class="glass-card p-6 rounded-2xl border-b-4 border-medical">
                    <p class="text-[10px] uppercase opacity-50">Atendidos</p>
                    <h3 class="text-2xl md:text-3xl" id="prod-total">0</h3>
                </div>
                <div class="glass-card p-6 rounded-2xl border-b-4 border-cyber">
                    <p class="text-[10px] uppercase opacity-50">Taxa de Conversão</p>
                    <h3 class="text-2xl md:text-3xl" id="prod-taxa">0%</h3>
                </div>
            </div>
            <div id="financeiro-resumo" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
        </div>

        <div id="sec-oticas" class="hidden content-sec">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-8 text-white">
                <h2 class="text-3xl font-bold italic uppercase">Óticas</h2>
                <button onclick="window.openModalCadastro('otica')" class="btn-medical w-full sm:w-auto px-6 py-2 rounded-xl">Nova Ótica</button>
            </div>
            <div id="grid-oticas" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div id="sec-templates" class="hidden content-sec">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-8 text-white">
                <h2 class="text-3xl font-bold italic uppercase">MENSAGENS</h2>
                <button onclick="window.openModalCadastro('template')" class="btn-medical w-full sm:w-auto px-6 py-2 rounded-xl">Novo Modelo</button>
            </div>
            <div id="grid-templates" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </main>

    <!-- MODAL PACIENTE -->
    <div id="modal-paciente" class="fixed inset-0 bg-black/95 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-2 md:p-4">
        <div class="glass-card bg-surface p-4 md:p-8 rounded-[1.5rem] md:rounded-[2rem] w-full max-w-5xl shadow-2xl max-h-[95vh] overflow-y-auto text-white">
            <div class="flex flex-col md:flex-row justify-between items-start gap-4 mb-6">
                <div class="w-full">
                    <h3 class="text-xl md:text-2xl font-bold italic text-medical" id="title-paciente">Ficha do Paciente</h3>
                    <div class="flex gap-4 mt-4 overflow-x-auto pb-2">
                        <button onclick="window.switchTab('cadastro')" id="tab-btn-cadastro" class="tab-btn active whitespace-nowrap text-[10px] font-bold uppercase tracking-wider">Dados Gerais</button>
                        <button onclick="window.switchTab('historico')" id="tab-btn-historico" class="tab-btn whitespace-nowrap text-[10px] font-bold uppercase tracking-wider">Histórico de Exames</button>
                    </div>
                </div>
                <button onclick="window.openExame()" class="w-full md:w-auto bg-cyber/20 text-cyber px-4 py-3 rounded-xl font-bold text-[10px] uppercase hover:bg-cyber transition-all"><span>Cadastrar Novo Prontuário</span></button>
            </div>
            
            <div id="aba-cadastro" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                <div class="sm:col-span-2"><label class="text-[9px] uppercase font-bold opacity-40">Nome Completo</label><input type="text" id="p-nome" oninput="window.autoFillPaciente(this.value)" class="input-clinical"></div>
                <div><label class="text-[9px] uppercase font-bold opacity-40">Sexo</label><select id="p-sexo" class="input-clinical"><option value="M">Masculino</option><option value="F">Feminino</option></select></div>
                <div><label class="text-[9px] uppercase font-bold opacity-40">Data Nascimento</label><input type="date" id="p-nascimento" onchange="window.updateAge(this.value)" class="input-clinical"></div>
                <div><label class="text-[9px] uppercase font-bold opacity-40">Idade Calculada</label><input type="text" id="p-idade-calc" readonly class="input-clinical border-none bg-white/5"></div>
                <div><label class="text-[9px] uppercase font-bold text-cyber">CPF</label><input type="text" id="p-cpf" placeholder="000.000.000-00" maxlength="14" oninput="window.mascaraCPF(this)" class="input-clinical"></div>
                <div><label class="text-[9px] uppercase font-bold opacity-40">WhatsApp</label><input type="text" id="p-tel" oninput="window.mascaraTelefone(this)" maxlength="15" placeholder="(00) 00000-0000" class="input-clinical"></div>
                <div><label class="text-[9px] uppercase font-bold opacity-40">Origem</label><input type="text" id="p-origem" class="input-clinical"></div>
                <div><label class="text-[9px] uppercase font-bold opacity-40">Profissão</label><input type="text" id="p-profissao" class="input-clinical"></div>
                <div><label class="text-[9px] uppercase font-bold opacity-40">Passatempo</label><input type="text" id="p-passatempo" class="input-clinical"></div>
                <div class="sm:col-span-2"><label class="text-[9px] uppercase font-bold opacity-40">Endereço</label><input type="text" id="p-endereco" class="input-clinical"></div>
                <div><label class="text-[9px] uppercase font-bold opacity-40">Último Exame</label><input type="date" id="p-ultimo-exame" class="input-clinical"></div>
                <div class="sm:col-span-2"><label class="text-[9px] uppercase font-bold opacity-40">Ajuda Óptica Prescrita</label><input type="text" id="p-ajuda" class="input-clinical"></div>
                <div><label class="text-[9px] uppercase font-bold opacity-40">Responsável</label><input type="text" id="p-responsavel" class="input-clinical"></div>
                <div><label class="text-[9px] uppercase font-bold text-medical">Data Agenda</label><input type="date" id="p-data-agenda" class="input-clinical border-medical/40"></div>
                <div><label class="text-[9px] uppercase font-bold text-medical">Hora</label><input type="time" id="p-hora" class="input-clinical border-medical/40"></div>
                <div class="sm:col-span-3 grid grid-cols-1 sm:grid-cols-3 gap-4 mt-2">
                    <div><label class="text-[9px] uppercase font-bold opacity-40">Ótica</label><select id="p-otica" class="input-clinical"></select></div>
                    <div><label class="text-[9px] uppercase font-bold opacity-40">Status</label><select id="p-status-modal" class="input-clinical"><option value="Agendado">Agendado</option><option value="Recepção">Recepção</option><option value="Consulta">Consulta</option><option value="Finalizado">Finalizado</option></select></div>
                    <div><label class="text-[9px] uppercase font-bold opacity-40">Pagamento</label><select id="p-pago-modal" class="input-clinical"><option value="Pendente">Pendente</option><option value="Pago">Pago</option></select></div>
                </div>
            </div>

            <div id="aba-historico" class="hidden space-y-6">
                <div id="historico-render" class="grid grid-cols-1 gap-6"></div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 mt-8">
                <button onclick="window.savePatient()" class="flex-1 btn-medical py-4 rounded-xl uppercase font-bold text-white order-2 sm:order-1">Salvar Registro</button>
                <button onclick="window.closeModal('modal-paciente')" class="w-full sm:w-32 bg-white/5 py-4 rounded-xl uppercase text-[10px] font-bold text-white order-1 sm:order-2">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PRONTUÁRIO -->
    <div id="modal-exame" class="fixed inset-0 bg-black/98 backdrop-blur-md hidden z-[110] flex items-center justify-center p-2 md:p-4">
        <div class="glass-card bg-surface p-4 md:p-10 rounded-[1.5rem] md:rounded-[2rem] w-full max-w-4xl shadow-2xl max-h-[90vh] overflow-y-auto text-white">
            <h3 class="text-2xl md:text-3xl font-bold italic text-medical mb-8 uppercase tracking-tighter" id="title-modal-exame">Novo Exame Clínico</h3>
            
            <div class="space-y-10">
                <div>
                    <h4 class="text-medical font-bold text-lg mb-4 uppercase flex items-center gap-2"><i data-lucide="eye"></i> 15. RX FINAL</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full rx-table text-center text-white min-w-[500px]">
                            <thead><tr><th class="w-16"></th><th>ESF.</th><th>CIL.</th><th>EIXO.</th><th>AV LONGE</th><th>AV PERTO</th></tr></thead>
                            <tbody>
                                <tr><th class="bg-white/5">OD</th><td><input type="text" id="rx-od-esf"></td><td><input type="text" id="rx-od-cil"></td><td><input type="text" id="rx-od-eixo" onblur="window.formatDegree(this)"></td><td><input type="text" id="rx-od-av" onblur="window.formatAV(this)"></td><td><input type="text" id="rx-od-av-perto" onblur="window.formatAVPerto(this)"></td></tr>
                                <tr><th class="bg-white/5">OE</th><td><input type="text" id="rx-oe-esf"></td><td><input type="text" id="rx-oe-cil"></td><td><input type="text" id="rx-oe-eixo" onblur="window.formatDegree(this)"></td><td><input type="text" id="rx-oe-av" onblur="window.formatAV(this)"></td><td><input type="text" id="rx-oe-av-perto" onblur="window.formatAVPerto(this)"></td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                        <div class="flex items-center gap-2 bg-white/5 p-3 rounded-xl text-[10px]"><b>ADD:</b> <input type="text" id="rx-add" class="bg-transparent outline-none w-full"></div>
                        <div class="flex items-center gap-2 bg-white/5 p-3 rounded-xl text-[10px]"><b>DP:</b> <input type="text" id="rx-dp" class="bg-transparent outline-none w-full"></div>
                    </div>
                </div>
                
                <div>
                    <h4 class="text-medical font-bold text-lg mb-4 uppercase flex items-center gap-2"><i data-lucide="activity"></i> 7. OFTALMOSCOPIA</h4>
                    <div class="flex items-center gap-2 bg-white/5 p-3 rounded-xl mb-4 text-[10px] font-bold text-white">BRUCKNER: <input type="text" id="oft-bruckner" class="bg-transparent outline-none w-full"></div>
                    <div class="overflow-x-auto">
                        <table class="w-full rx-table text-[10px] text-white min-w-[500px]">
                            <thead><tr><th>Aspecto</th><th>Olho Direito</th><th>Olho Esquerdo</th></tr></thead>
                            <tbody class="text-center">
                                <tr><th class="bg-white/5">Papila</th><td><input type="text" id="oft-od-papila"></td><td><input type="text" id="oft-oe-papila"></td></tr>
                                <tr><th class="bg-white/5">Escavação</th><td><input type="text" id="oft-od-escav"></td><td><input type="text" id="oft-oe-escav"></td></tr>
                                <tr><th class="bg-white/5">Mácula</th><td><input type="text" id="oft-od-macula"></td><td><input type="text" id="oft-oe-macula"></td></tr>
                                <tr><th class="bg-white/5">Fixação</th><td><input type="text" id="oft-od-fixacao"></td><td><input type="text" id="oft-oe-fixacao"></td></tr>
                                <tr><th class="bg-white/5">Relação A/V</th><td><input type="text" id="oft-od-relacao-av"></td><td><input type="text" id="oft-oe-relacao-av"></td></tr>
                                <tr><th class="bg-white/5">Cor</th><td><input type="text" id="oft-od-cor"></td><td><input type="text" id="oft-oe-cor"></td></tr>
                                <tr><th class="bg-white/5">Lente</th><td><input type="text" id="oft-od-lente"></td><td><input type="text" id="oft-oe-lente"></td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4"><b class="text-[10px] uppercase opacity-50">Observações:</b><textarea id="oft-obs" class="input-clinical mt-2 h-24"></textarea></div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 mt-10">
                <button onclick="window.saveExame()" class="flex-1 btn-medical py-4 rounded-2xl font-bold uppercase">Salvar Prontuário</button>
                <button onclick="window.closeModal('modal-exame')" class="w-full sm:w-32 bg-white/5 py-4 rounded-2xl font-bold uppercase text-[10px]">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAIS AUXILIARES -->
    <div id="modal-otica" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden z-[100] flex items-center justify-center p-4"><div class="glass-card bg-surface p-6 md:p-8 rounded-[1.5rem] md:rounded-[2rem] w-full max-w-md shadow-2xl text-white"><h3 class="text-xl md:text-2xl font-bold mb-6" id="title-otica">Ótica</h3><div class="space-y-4"><input type="text" id="ot-nome" placeholder="Nome" class="input-clinical text-white"><select id="ot-tipo" class="input-clinical text-white"><option value="Paciente">Por Atendimento</option><option value="Diária">Diária Fixa</option><option value="Retorno">Retorno</option></select><input type="number" id="ot-valor" placeholder="Valor R$" class="input-clinical text-white"><input type="color" id="ot-cor" class="w-full h-12 bg-transparent cursor-pointer"><div class="flex flex-col sm:flex-row gap-3 pt-4"><button onclick="window.saveOtica()" class="flex-1 btn-medical py-3 rounded-xl">SALVAR</button><button onclick="window.closeModal('modal-otica')" class="flex-1 bg-white/5 py-3 rounded-xl font-bold">FECHAR</button></div></div></div></div>
    
    <div id="modal-template" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden z-[100] flex items-center justify-center p-4"><div class="glass-card bg-surface p-6 md:p-8 rounded-[1.5rem] md:rounded-[2rem] w-full max-w-lg shadow-2xl text-white"><h3 class="text-xl md:text-2xl font-bold mb-4" id="title-template">Template CRM</h3><input type="text" id="t-titulo" placeholder="Título" class="input-clinical text-white mb-4"><textarea id="t-texto" rows="6" placeholder="Mensagem..." class="input-clinical text-white"></textarea><div class="flex flex-col sm:flex-row gap-3 pt-4"><button onclick="window.saveTemplate()" class="flex-1 btn-medical py-3 rounded-xl">SALVAR</button><button onclick="window.closeModal('modal-template')" class="flex-1 bg-white/5 py-3 rounded-xl font-bold">VOLTAR</button></div></div></div>
    
    <div id="modal-pick" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden z-[100] flex items-center justify-center p-4"><div class="glass-card bg-surface p-6 md:p-8 rounded-[1.5rem] md:rounded-[2rem] w-full max-w-md text-center text-white"><h3 class="text-xl font-bold mb-2 italic">Enviar Mensagem</h3><p id="target-name" class="text-medical mb-6 font-bold uppercase"></p><div id="pick-list" class="space-y-2"></div><button onclick="window.closeModal('modal-pick')" class="w-full mt-4 py-3 bg-white/5 rounded-xl font-bold uppercase text-white">Fechar</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, orderBy, updateDoc, where, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURAÇÕES DO FIREBASE (AS MESMAS DO CÓDIGO ORIGINAL)
        const firebaseConfig = {
            apiKey: "AIzaSyD60DbZUm3e6NPVteWtHY3T86ACi1ys5VY",
            authDomain: "agendaatendimento-473c1.firebaseapp.com",
            projectId: "agendaatendimento-473c1",
            storageBucket: "agendaatendimento-473c1.firebasestorage.app",
            messagingSenderId: "624037217398",
            appId: "1:624037217398:web:90887ae72197d6f6278b57",
            measurementId: "G-04J2905PQJ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let oticas = [], pacientes = [], templates = [], editPId = null, editOId = null, editTId = null, editEId = null, filtroStatus = "Todos", filtroOtica = "", filtroMesAgenda = "", filtroDataAgendado = "", filtroBuscaPaciente = "";

        const now = new Date();
        document.getElementById('display-date').innerText = new Intl.DateTimeFormat('pt-BR', { dateStyle: 'full' }).format(now);
        document.getElementById('filtro-mes').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

        // TOGGLE SIDEBAR MOBILE
        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('open');
        }

        window.nav = (id) => { 
            document.querySelectorAll('.content-sec').forEach(s => s.classList.add('hidden')); 
            document.getElementById('sec-' + id).classList.remove('hidden'); 
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
            const targetBtn = Array.from(document.querySelectorAll('.nav-item')).find(btn => btn.getAttribute('onclick').includes(`nav('${id}')`));
            if(targetBtn) targetBtn.classList.add('active');
            if(window.innerWidth < 1024) toggleSidebar(); // Fecha sidebar ao clicar no mobile
        };

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => { document.getElementById(id).classList.add('hidden'); };

        window.openModalCadastro = (tipo) => {
            if(tipo === 'paciente') { 
                editPId = null; 
                document.getElementById('title-paciente').innerText = "Novo Agendamento"; 
                const campos = ['p-nome', 'p-nascimento', 'p-idade-calc', 'p-cpf', 'p-tel', 'p-origem', 'p-profissao', 'p-passatempo', 'p-endereco', 'p-ultimo-exame', 'p-ajuda', 'p-responsavel', 'p-data-agenda', 'p-hora'];
                campos.forEach(id => { if(document.getElementById(id)) document.getElementById(id).value = ""; });
                if(document.getElementById('p-sexo')) document.getElementById('p-sexo').value = "M";
                if(document.getElementById('p-otica')) document.getElementById('p-otica').value = "";
                if(document.getElementById('p-status-modal')) document.getElementById('p-status-modal').value = "Agendado";
                if(document.getElementById('p-pago-modal')) document.getElementById('p-pago-modal').value = "Pendente";
                window.switchTab('cadastro');
                window.openModal('modal-paciente'); 
            }
            else if(tipo === 'otica') { editOId = null; document.getElementById('ot-nome').value = ""; document.getElementById('ot-valor').value = ""; document.getElementById('title-otica').innerText = "Cadastrar Ótica"; window.openModal('modal-otica'); }
            else { editTId = null; document.getElementById('t-titulo').value = ""; document.getElementById('t-texto').value = ""; document.getElementById('title-template').innerText = "Novo Template"; window.openModal('modal-template'); }
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-btn-' + tab).classList.add('active');
            if(tab === 'cadastro') {
                document.getElementById('aba-cadastro').classList.remove('hidden');
                document.getElementById('aba-historico').classList.add('hidden');
            } else {
                document.getElementById('aba-cadastro').classList.add('hidden');
                document.getElementById('aba-historico').classList.remove('hidden');
                renderHistoricoCompleto();
            }
        }

        window.openExame = () => {
            editEId = null;
            document.getElementById('title-modal-exame').innerText = "Novo Exame Clínico";
            const campos = ['rx-od-esf','rx-od-cil','rx-od-eixo','rx-od-av','rx-od-av-perto','rx-oe-esf','rx-oe-cil','rx-oe-eixo','rx-oe-av','rx-oe-av-perto','rx-add','rx-dp','oft-bruckner','oft-od-papila','oft-oe-papila','oft-od-escav','oft-oe-escav','oft-od-macula','oft-oe-macula','oft-od-fixacao','oft-oe-fixacao','oft-od-relacao-av','oft-oe-relacao-av','oft-od-cor','oft-od-cor','oft-od-lente','oft-oe-lente','oft-obs'];
            campos.forEach(id => { if(document.getElementById(id)) document.getElementById(id).value = ""; });
            window.openModal('modal-exame');
        };

        window.formatDegree = (i) => { if(i.value && !i.value.includes('°')) i.value += '°'; };
        window.formatAV = (i) => { if(i.value && !i.value.startsWith('20/')) i.value = '20/' + i.value; };
        window.formatAVPerto = (i) => { if(i.value && !i.value.toUpperCase().startsWith('J')) i.value = 'J' + i.value.toUpperCase(); };
        window.mascaraCPF = (i) => { let v = i.value.replace(/\D/g, ""); if (v.length > 11) v = v.substring(0, 11); v = v.replace(/(\d{3})(\d)/, "$1.$2"); v = v.replace(/(\d{3})(\d)/, "$1.$2"); v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2"); i.value = v; };
        window.mascaraTelefone = (i) => {
            let v = i.value.replace(/\D/g, "");
            if (v.length > 11) v = v.substring(0, 11);
            if (v.length >= 11) v = v.replace(/^(\d{2})(\d{5})(\d{4})/, "($1) $2-$3");
            else if (v.length >= 7) v = v.replace(/^(\d{2})(\d{4})(\d{0,4})/, "($1) $2-$3");
            i.value = v;
        };

        window.updateAge = (nascimento) => { if(!nascimento) return; const birth = new Date(nascimento), now = new Date(); let y = now.getFullYear() - birth.getFullYear(); document.getElementById('p-idade-calc').value = `${y} anos`; };

        window.autoFillPaciente = (nome) => {
            if(nome.length < 3) return;
            const p = pacientes.find(item => item.nome.toLowerCase() === nome.toLowerCase());
            if(p && !editPId) {
                document.getElementById('p-tel').value = p.tel || ""; document.getElementById('p-nascimento').value = p.nascimento || ""; document.getElementById('p-cpf').value = p.cpf || "";
                window.updateAge(p.nascimento); document.getElementById('p-sexo').value = p.sexo || "M"; document.getElementById('p-origem').value = p.origem || "";
                document.getElementById('p-profissao').value = p.profissao || ""; document.getElementById('p-passatempo').value = p.passatempo || "";
                document.getElementById('p-endereco').value = p.endereco || ""; document.getElementById('p-ultimo-exame').value = p.ultimoExame || "";
                document.getElementById('p-ajuda').value = p.ajuda || ""; document.getElementById('p-responsavel').value = p.responsavel || "";
            }
        };

        window.saveExame = async () => {
            const nome = document.getElementById('p-nome').value;
            if(!nome) return alert("Informe o nome do paciente.");
            const dataExame = {
                pacienteNome: nome, 
                data: editEId ? document.getElementById('title-modal-exame').getAttribute('data-date') : new Date().toLocaleDateString('pt-BR'),
                timestamp: editEId ? parseInt(document.getElementById('title-modal-exame').getAttribute('data-ts')) : Date.now(),
                rx_od_esf: document.getElementById('rx-od-esf').value, rx_od_cil: document.getElementById('rx-od-cil').value, rx_od_eixo: document.getElementById('rx-od-eixo').value, rx_od_av: document.getElementById('rx-od-av').value, rx_od_av_perto: document.getElementById('rx-od-av-perto').value,
                rx_oe_esf: document.getElementById('rx-oe-esf').value, rx_oe_cil: document.getElementById('rx-oe-cil').value, rx_oe_eixo: document.getElementById('rx-oe-eixo').value, rx_oe_av: document.getElementById('rx-oe-av').value, rx_oe_av_perto: document.getElementById('rx-oe-av-perto').value,
                rx_add: document.getElementById('rx-add').value, rx_dp: document.getElementById('rx-dp').value,
                oft_bruckner: document.getElementById('oft-bruckner').value, oft_od_papila: document.getElementById('oft-od-papila').value, oft_oe_papila: document.getElementById('oft-oe-papila').value, 
                oft_od_escav: document.getElementById('oft-od-escav').value, oft_oe_escav: document.getElementById('oft-oe-escav').value,
                oft_od_macula: document.getElementById('oft-od-macula').value, oft_oe_macula: document.getElementById('oft-oe-macula').value,
                oft_od_fixacao: document.getElementById('oft-od-fixacao').value, oft_oe_fixacao: document.getElementById('oft-oe-fixacao').value,
                oft_od_relacao_av: document.getElementById('oft-od-relacao-av').value, oft_oe_relacao_av: document.getElementById('oft-oe-relacao-av').value,
                oft_od_cor: document.getElementById('oft-od-cor').value, oft_oe_cor: document.getElementById('oft-oe-cor').value,
                oft_od_lente: document.getElementById('oft-od-lente').value, oft_oe_lente: document.getElementById('oft-oe-lente').value,
                oft_obs: document.getElementById('oft-obs').value
            };

            if(editEId) {
                await updateDoc(doc(db, "historicos", editEId), dataExame);
                alert("Prontuário atualizado!");
            } else {
                await addDoc(collection(db, "historicos"), dataExame);
                alert("Prontuário salvo!");
            }
            window.closeModal('modal-exame'); 
            renderHistoricoCompleto();
        };

        window.editExame = async (id) => {
            const docRef = doc(db, "historicos", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const h = docSnap.data();
                editEId = id;
                document.getElementById('title-modal-exame').innerText = "Editar Exame Clínico";
                document.getElementById('title-modal-exame').setAttribute('data-date', h.data);
                document.getElementById('title-modal-exame').setAttribute('data-ts', h.timestamp);

                const campos = {
                    'rx-od-esf': h.rx_od_esf, 'rx-od-cil': h.rx_od_cil, 'rx-od-eixo': h.rx_od_eixo, 'rx-od-av': h.rx_od_av, 'rx-od-av-perto': h.rx_od_av_perto,
                    'rx-oe-esf': h.rx_oe_esf, 'rx-oe-cil': h.rx_oe_cil, 'rx-oe-eixo': h.rx_oe_eixo, 'rx-oe-av': h.rx_oe_av, 'rx-oe-av-perto': h.rx_oe_av_perto,
                    'rx-add': h.rx_add, 'rx-dp': h.rx_dp, 'oft-bruckner': h.oft_bruckner,
                    'oft-od-papila': h.oft_od_papila, 'oft-oe-papila': h.oft_oe_papila, 'oft-od-escav': h.oft_od_escav, 'oft-oe-escav': h.oft_oe_escav,
                    'oft-od-macula': h.oft_od_macula, 'oft-oe-macula': h.oft_oe_macula, 'oft-od-fixacao': h.oft_od_fixacao, 'oft-oe-fixacao': h.oft_oe_fixacao,
                    'oft-od-relacao-av': h.oft_od_relacao_av, 'oft-oe-relacao-av': h.oft_oe_relacao_av, 'oft-od-cor': h.oft_od_cor, 'oft-oe-cor': h.oft_oe_cor,
                    'oft-od-lente': h.oft_od_lente, 'oft-oe-lente': h.oft_oe_lente, 'oft-obs': h.oft_obs
                };

                for (let key in campos) {
                    if(document.getElementById(key)) document.getElementById(key).value = campos[key] || "";
                }
                window.openModal('modal-exame');
            }
        };

        async function renderHistoricoCompleto() {
            const nome = document.getElementById('p-nome').value;
            const container = document.getElementById('historico-render');
            container.innerHTML = '<p class="text-xs animate-pulse text-medical">Buscando exames...</p>';
            const q = query(collection(db, "historicos"), where("pacienteNome", "==", nome));
            const querySnapshot = await getDocs(q);
            if(querySnapshot.empty) { container.innerHTML = '<div class="py-10 text-center opacity-30 uppercase text-xs font-bold tracking-widest">Nenhum exame encontrado.</div>'; return; }
            container.innerHTML = "";
            const docs = querySnapshot.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.timestamp - a.timestamp);
            docs.forEach((h) => {
                container.innerHTML += `
                    <div class="glass-card p-4 md:p-6 rounded-3xl border-l-4 border-medical bg-white/[0.02]">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-[10px] bg-medical px-2 py-1 rounded-lg font-bold uppercase tracking-wider">EXAME EM ${h.data}</span>
                            <div class="flex gap-2">
                                <button onclick="window.editExame('${h.id}')" class="text-medical p-2"><i data-lucide="edit-3" class="w-4"></i></button>
                                <button onclick="window.apagar('historicos', '${h.id}')" class="text-red-500 p-2"><i data-lucide="trash-2" class="w-4"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-white/5 p-4 rounded-xl">
                                <h5 class="text-cyber text-[9px] font-bold uppercase mb-2">RX FINAL - OD</h5>
                                <p class="text-sm font-bold">ESF: ${h.rx_od_esf || '-'} | CIL: ${h.rx_od_cil || '-'} | EIXO: ${h.rx_od_eixo || '-'}</p>
                                <p class="text-[10px] opacity-50 mt-1 uppercase font-mono">AV: ${h.rx_od_av || '-'} / ${h.rx_od_av_perto || '-'}</p>
                            </div>
                            <div class="bg-white/5 p-4 rounded-xl">
                                <h5 class="text-cyber text-[9px] font-bold uppercase mb-2">RX FINAL - OE</h5>
                                <p class="text-sm font-bold">ESF: ${h.rx_oe_esf || '-'} | CIL: ${h.rx_oe_cil || '-'} | EIXO: ${h.rx_oe_eixo || '-'}</p>
                                <p class="text-[10px] opacity-50 mt-1 uppercase font-mono">AV: ${h.rx_oe_av || '-'} / ${h.rx_oe_av_perto || '-'}</p>
                            </div>
                        </div>
                        <div class="bg-medical/10 border border-medical/20 p-3 rounded-xl mb-4 flex justify-between items-center px-4 md:px-6">
                            <span class="text-[10px] font-bold uppercase text-medical tracking-widest">Adição (ADD)</span>
                            <span class="text-lg font-bold text-white">${h.rx_add || '---'}</span>
                        </div>
                        <div class="overflow-hidden border border-white/5 rounded-xl mb-4">
                            <div class="overflow-x-auto">
                                <table class="w-full text-[10px] text-center min-w-[300px]">
                                    <thead class="bg-white/5 text-cyber uppercase">
                                        <tr><th class="p-2">Aspectos</th><th class="p-2">OD</th><th class="p-2">OE</th></tr>
                                    </thead>
                                    <tbody class="divide-y divide-white/5">
                                        <tr><td class="p-2 opacity-40">Papila</td><td>${h.oft_od_papila || '-'}</td><td>${h.oft_oe_papila || '-'}</td></tr>
                                        <tr><td class="p-2 opacity-40">Escavação</td><td>${h.oft_od_escav || '-'}</td><td>${h.oft_oe_escav || '-'}</td></tr>
                                        <tr><td class="p-2 opacity-40">Mácula</td><td>${h.oft_od_macula || '-'}</td><td>${h.oft_oe_macula || '-'}</td></tr>
                                        <tr><td class="p-2 opacity-40">Fixação</td><td>${h.oft_od_fixacao || '-'}</td><td>${h.oft_oe_fixacao || '-'}</td></tr>
                                        <tr><td class="p-2 opacity-40">Relação A/V</td><td>${h.oft_od_relacao_av || '-'}</td><td>${h.oft_oe_relacao_av || '-'}</td></tr>
                                        <tr><td class="p-2 opacity-40">Cor</td><td>${h.oft_od_cor || '-'}</td><td>${h.oft_oe_cor || '-'}</td></tr>
                                        <tr><td class="p-2 opacity-40">Lente</td><td>${h.oft_od_lente || '-'}</td><td>${h.oft_oe_lente || '-'}</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-4 text-[10px] font-bold">
                             <div>DP: <span class="text-medical">${h.rx_dp || '-'}</span></div>
                             <div>BRUCKNER: <span class="text-medical">${h.oft_bruckner || '-'}</span></div>
                        </div>
                        ${h.oft_obs ? `<div class="mt-4 p-3 bg-white/5 rounded-xl text-[11px] italic opacity-80 border border-white/5">Obs: ${h.oft_obs}</div>` : ''}
                    </div>
                `;
            });
            lucide.createIcons();
        }

        window.savePatient = async () => {
            const oId = document.getElementById('p-otica').value; const oRel = oticas.find(o => o.id === oId);
            const data = {
                nome: document.getElementById('p-nome').value, sexo: document.getElementById('p-sexo').value, nascimento: document.getElementById('p-nascimento').value, idadeText: document.getElementById('p-idade-calc').value, cpf: document.getElementById('p-cpf').value, tel: document.getElementById('p-tel').value, origem: document.getElementById('p-origem').value, profissao: document.getElementById('p-profissao').value, passatempo: document.getElementById('p-passatempo').value, endereco: document.getElementById('p-endereco').value, ultimoExame: document.getElementById('p-ultimo-exame').value, ajuda: document.getElementById('p-ajuda').value, responsavel: document.getElementById('p-responsavel').value, data: document.getElementById('p-data-agenda').value, hora: document.getElementById('p-hora').value, status: document.getElementById('p-status-modal').value, pago: document.getElementById('p-pago-modal').value === "Pago", oticaId: oId, oticaNome: oRel ? oRel.nome : "Particular", oticaCor: oRel ? oRel.cor : "#ffffff", valorConsulta: (oRel && oRel.tipo === 'Paciente') ? oRel.valor : 0
            };
            if(editPId) await updateDoc(doc(db, "pacientes", editPId), data); else await addDoc(collection(db, "pacientes"), {...data, created: Date.now()});
            window.closeModal('modal-paciente');
        };

        window.imprimirLista = () => {
            let f = pacientes;
            if (filtroStatus === "Agendado" && filtroDataAgendado !== "") f = f.filter(p => p.status === "Agendado" && p.data === filtroDataAgendado);
            else if (filtroStatus !== "Todos") f = f.filter(p => p.status === filtroStatus);
            if (filtroOtica !== "") f = f.filter(p => p.oticaId === filtroOtica);
            if (filtroMesAgenda !== "") f = f.filter(p => p.data && p.data.startsWith(filtroMesAgenda));
            if(f.length === 0) return alert("A lista atual está vazia para impressão.");

            let totalPago = 0; let totalPendente = 0;
            const nomeOtica = filtroOtica ? (oticas.find(o => o.id === filtroOtica)?.nome || "Geral") : "Geral";

            const win = window.open('', '', 'height=700,width=900');
            win.document.write('<html><head><title>Relatório de Pacientes</title>');
            win.document.write('<style>body{font-family:sans-serif;padding:30px;color:#333} table{width:100%;border-collapse:collapse;margin-top:20px} th,td{border:1px solid #ddd;padding:10px;text-align:left;font-size:12px} th{background:#f8fafc;text-transform:uppercase} .summary{margin-top:30px;padding:20px;background:#f1f5f9;border-radius:10px} .total-line{display:flex;justify-content:space-between;margin-bottom:5px;font-weight:bold} .pago{color:#16a34a} .pendente{color:#dc2626}</style>');
            win.document.write('</head><body>');
            win.document.write(`<h1>Lista de Clientes - ${nomeOtica}</h1>`);
            win.document.write(`<p>Gerado em: ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}</p>`);
            win.document.write('<table><thead><tr><th>Data</th><th>Hora</th><th>Paciente</th><th>Status</th><th>Valor</th><th>Pagamento</th></tr></thead><tbody>');

            f.forEach(p => {
                const val = parseFloat(p.valorConsulta || 0);
                if(p.pago) totalPago += val; else totalPendente += val;
                win.document.write(`<tr><td>${p.data}</td><td>${p.hora}</td><td>${p.nome}</td><td>${p.status}</td><td>R$ ${val.toFixed(2)}</td><td>${p.pago ? 'Pago' : 'Pendente'}</td></tr>`);
            });

            win.document.write('</tbody></table>');
            win.document.write(`
                <div class="summary">
                    <div class="total-line pago"><span>Total Já Pago:</span> <span>R$ ${totalPago.toFixed(2)}</span></div>
                    <div class="total-line pendente"><span>Total Pendente:</span> <span>R$ ${totalPendente.toFixed(2)}</span></div>
                    <div class="total-line" style="border-top:1px solid #ccc; padding-top:10px; margin-top:10px; font-size:16px"><span>VALOR TOTAL (PAGOS + PENDENTES):</span> <span>R$ ${(totalPago + totalPendente).toFixed(2)}</span></div>
                </div>
            `);
            win.document.write('</body></html>');
            win.document.close();
            win.print();
        };

        window.filtrarStatus = (st) => { filtroStatus = st; document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active')); document.getElementById('btn-' + st).classList.add('active'); const cal = document.getElementById('cal-agendado'); if(st === 'Agendado') { cal.classList.remove('hidden'); } else { cal.classList.add('hidden'); filtroDataAgendado = ""; } renderAgenda(); };
        window.selecionarDataAgendado = (val) => { filtroDataAgendado = val; renderAgenda(); };
        window.filtrarPorOtica = (id) => { filtroOtica = id; renderAgenda(); };
        window.filtrarPorMesAgenda = (val) => { filtroMesAgenda = val; renderAgenda(); };
        window.filtrarBuscaPaciente = (v) => { filtroBuscaPaciente = v.toLowerCase(); renderDatabasePacientes(); };
        window.limparBuscaPaciente = () => { filtroBuscaPaciente = ""; document.getElementById('search-paciente').value = ""; renderDatabasePacientes(); };
        window.limparFiltros = () => { filtroStatus = "Todos"; filtroOtica = ""; filtroMesAgenda = ""; filtroDataAgendado = ""; document.getElementById('filtro-otica-agenda').value = ""; document.getElementById('filtro-mes-agenda').value = ""; document.getElementById('cal-agendado').classList.add('hidden'); window.filtrarStatus('Todos'); };

        onSnapshot(collection(db, "oticas"), (snap) => { 
            oticas = snap.docs.map(d => ({id: d.id, ...d.data()})); 
            const s1 = document.getElementById('p-otica'), s2 = document.getElementById('filtro-otica-agenda'); 
            s1.innerHTML = '<option value="">Particular</option>'; s2.innerHTML = '<option value="">Ótica</option>'; 
            oticas.forEach(o => { s1.innerHTML += `<option value="${o.id}">${o.nome}</option>`; s2.innerHTML += `<option value="${o.id}">${o.nome}</option>`; }); 
            renderOticas();
        });

        onSnapshot(collection(db, "pacientes"), (snap) => { 
            pacientes = snap.docs.map(d => ({id: d.id, ...d.data()})); 
            renderAgenda(); 
            renderDatabasePacientes(); 
            calcularFinanceiro(); 
        });

        onSnapshot(collection(db, "templates"), (snap) => { templates = snap.docs.map(d => ({id: d.id, ...d.data()})); renderTemplates(); });

        function renderAgenda() { 
            const lista = document.getElementById('lista-agenda'); lista.innerHTML = ""; 
            let f = pacientes; 
            if (filtroStatus === "Agendado" && filtroDataAgendado !== "") f = f.filter(p => p.data === filtroDataAgendado); 
            else if (filtroStatus !== "Todos") f = f.filter(p => p.status === filtroStatus); 
            if (filtroOtica !== "") f = f.filter(p => p.oticaId === filtroOtica); 
            if (filtroMesAgenda !== "") f = f.filter(p => p.data && p.data.startsWith(filtroMesAgenda));
            
            const atendidosNoFiltro = f.filter(p => p.status === "Finalizado").length;
            document.getElementById('resumo-atendidos-agenda').innerText = atendidosNoFiltro;

            if(f.length === 0) { lista.innerHTML = '<tr><td colspan="6" class="p-6 text-center opacity-30 text-xs">Nenhum registro.</td></tr>'; }

            f.forEach(p => { 
                const stL = (p.status || "Agendado").toLowerCase().replace("ç", "c"); 
                lista.innerHTML += `<tr class="hover:bg-white/5 transition-all"><td class="py-2 px-6 text-[10px] whitespace-nowrap"><b>${p.data}</b> <br> ${p.hora}</td><td class="py-2 px-6 font-bold text-xs uppercase text-white whitespace-nowrap">${p.nome}</td><td class="py-2 px-6 whitespace-nowrap"><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full" style="background:${p.oticaCor}"></div><span class="text-[9px] uppercase font-bold text-slate-400">${p.oticaNome}</span></div></td><td class="py-2 px-6"><select onchange="window.changeStatus('${p.id}', this.value)" class="status-pill st-${stL} bg-transparent outline-none text-white"><option value="Agendado" ${p.status === 'Agendado' ? 'selected' : ''}>Agendado</option><option value="Recepção" ${p.status === 'Recepção' ? 'selected' : ''}>Recepção</option><option value="Consulta" ${p.status === 'Consulta' ? 'selected' : ''}>Consulta</option><option value="Finalizado" ${p.status === 'Finalizado' ? 'selected' : ''}>Finalizado</option></select></td><td class="py-2 px-6 text-center"><button onclick="window.togglePago('${p.id}', ${p.pago})" class="p-2"><i data-lucide="${p.pago ? 'check-circle' : 'clock'}" class="${p.pago ? 'text-green-500' : 'opacity-20'} w-4 mx-auto"></i></button></td><td class="py-2 px-6 text-right space-x-1 whitespace-nowrap"><button onclick="window.editPaciente('${p.id}')" class="p-2 hover:text-medical text-white"><i data-lucide="edit-3" class="w-4 h-4"></i></button><button onclick="window.openDisparo('${p.id}')" class="p-2 text-medical"><i data-lucide="send" class="w-4 h-4"></i></button><button onclick="window.imprimirLista()" class="p-2 text-cyber"><i data-lucide="printer" class="w-4 h-4"></i></button><button onclick="window.apagar('pacientes', '${p.id}')" class="p-2 text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`; 
            }); 
            lucide.createIcons(); 
        }

        function renderDatabasePacientes() { 
            const lista = document.getElementById('lista-db-pacientes'); lista.innerHTML = ""; 
            let f = pacientes; if(filtroBuscaPaciente !== "") f = f.filter(p => p.nome && p.nome.toLowerCase().includes(filtroBuscaPaciente)); 
            const baseUnica = Array.from(new Map(f.map(p => [p.nome, p])).values()); 
            baseUnica.forEach(p => { 
                lista.innerHTML += `<tr class="hover:bg-white/5 transition-all text-white"><td class="py-3 px-6 font-bold text-xs uppercase whitespace-nowrap">${p.nome}</td><td class="py-3 px-6 text-[10px] whitespace-nowrap">${p.idadeText || 'N/A'}</td><td class="py-3 px-6 font-mono text-[10px] whitespace-nowrap">${p.tel}</td><td class="py-3 px-6 text-[10px] whitespace-nowrap">${p.data || 'N/A'}</td><td class="py-3 px-6 text-right space-x-2 whitespace-nowrap"><button onclick="window.editPaciente('${p.id}')" class="p-2 hover:text-medical text-white"><i data-lucide="edit-3" class="w-4"></i></button><button onclick="window.openDisparo('${p.id}')" class="p-2 text-medical"><i data-lucide="send" class="w-4"></i></button></td></tr>`; 
            }); 
            lucide.createIcons(); 
        }

        window.calcularFinanceiro = () => { 
            const mes = document.getElementById('filtro-mes').value; 
            const res = document.getElementById('financeiro-resumo'); 
            res.innerHTML = ""; 
            const pMes = pacientes.filter(p => p.data && p.data.startsWith(mes));
            const finTotal = pMes.filter(p => p.status === "Finalizado"); 
            const pagosTotal = finTotal.filter(p => p.pago === true);
            
            let tg = 0; 

            const particulares = finTotal.filter(p => !p.oticaId || p.oticaId === "");
            const pagosParticulares = particulares.filter(p => p.pago === true);
            let rendPart = 0;
            pagosParticulares.forEach(p => rendPart += parseFloat(p.valorConsulta || 0));
            tg += rendPart;

            if(particulares.length > 0) {
                res.innerHTML += `<div class="glass-card p-6 rounded-3xl border-l-4 border-slate-500"><h4 class="text-xl font-bold uppercase text-white">Particulares</h4><h3 class="text-2xl font-bold mt-1 italic text-white">R$ ${rendPart.toFixed(2)}</h3><div class="mt-4 text-[10px] font-bold uppercase opacity-50 text-white">Atendidos: ${particulares.length} | Pagos: ${pagosParticulares.length}</div></div>`;
            }

            oticas.forEach(o => { 
                const fO = pMes.filter(p => p.status === "Finalizado" && p.oticaId === o.id);
                const pO = fO.filter(p => p.pago === true); 
                let rend = o.tipo === 'Diária' ? (pO.length > 0 ? o.valor : 0) : (pO.length * o.valor); 
                tg += rend; 
                if(fO.length > 0 || o.tipo === 'Diária') {
                    res.innerHTML += `<div class="glass-card p-6 rounded-3xl border-l-4" style="border-color:${o.cor}"><h4 class="text-xl font-bold uppercase text-white">${o.nome}</h4><h3 class="text-2xl font-bold mt-1 italic text-white">R$ ${rend.toFixed(2)}</h3><div class="mt-4 text-[10px] font-bold uppercase opacity-50 text-white">Fin: ${fO.length} | Pagos: ${pO.length}</div></div>`; 
                }
            }); 

            document.getElementById('total-global').innerText = `R$ ${tg.toFixed(2)}`; 
            document.getElementById('prod-total').innerText = finTotal.length; 
            document.getElementById('prod-taxa').innerText = `${pMes.length > 0 ? Math.round((finTotal.length / pMes.length) * 100) : 0}%`; 
        };

        function renderOticas() { const g = document.getElementById('grid-oticas'); g.innerHTML = ""; oticas.forEach(o => { g.innerHTML += `<div class="glass-card p-4 rounded-2xl border-t-4 group" style="border-color:${o.cor}"><div class="flex justify-between font-bold text-xs text-white"><h4>${o.nome}</h4><div class="flex gap-2"><button onclick="window.editOtica('${o.id}')" class="text-medical p-2"><i data-lucide="edit-3" class="w-4"></i></button><button onclick="window.apagar('oticas', '${o.id}')" class="text-red-500 p-2"><i data-lucide="trash" class="w-4"></i></button></div></div><p class="text-[9px] opacity-50 uppercase text-white">${o.tipo}</p><h3 class="text-xl font-bold mt-2 text-white">R$ ${o.valor.toFixed(2)}</h3></div>`; }); lucide.createIcons(); }
        
        function renderTemplates() { 
            const g = document.getElementById('grid-templates'); 
            g.innerHTML = ""; 
            templates.forEach(t => { 
                g.innerHTML += `<div class="glass-card p-4 rounded-2xl group"><div class="flex justify-between font-bold text-xs text-white mb-2"><h4 class="text-medical uppercase tracking-tighter">${t.titulo}</h4><div class="flex gap-2"><button onclick="window.editTemplate('${t.id}')" class="text-medical p-2"><i data-lucide="edit-3" class="w-4"></i></button><button onclick="window.apagar('templates', '${t.id}')" class="text-red-500 p-2"><i data-lucide="trash" class="w-4"></i></button></div></div><p class="text-[10px] text-slate-400 line-clamp-3 mb-2">${t.texto}</p></div>`; 
            }); 
            lucide.createIcons(); 
        }

        window.editPaciente = (id) => { 
            const p = pacientes.find(i => i.id === id); editPId = id; 
            document.getElementById('p-nome').value = p.nome || ""; document.getElementById('p-tel').value = p.tel || ""; 
            document.getElementById('p-data-agenda').value = p.data || ""; document.getElementById('p-hora').value = p.hora || ""; 
            document.getElementById('p-status-modal').value = p.status || "Agendado"; document.getElementById('p-pago-modal').value = p.pago ? "Pago" : "Pendente"; 
            document.getElementById('p-otica').value = p.oticaId || ""; document.getElementById('p-sexo').value = p.sexo || "M"; 
            document.getElementById('p-nascimento').value = p.nascimento || ""; document.getElementById('p-cpf').value = p.cpf || ""; 
            window.updateAge(p.nascimento); document.getElementById('p-origem').value = p.origem || ""; 
            document.getElementById('p-profissao').value = p.profissao || ""; document.getElementById('p-passatempo').value = p.passatempo || ""; 
            document.getElementById('p-endereco').value = p.endereco || ""; document.getElementById('p-ultimo-exame').value = p.ultimoExame || ""; 
            document.getElementById('p-ajuda').value = p.ajuda || ""; document.getElementById('p-responsavel').value = p.responsavel || ""; 
            window.openModal('modal-paciente'); 
        };

        window.editOtica = (id) => { const o = oticas.find(i => i.id === id); editOId = id; document.getElementById('ot-nome').value = o.nome; document.getElementById('ot-tipo').value = o.tipo; document.getElementById('ot-valor').value = o.valor; document.getElementById('ot-cor').value = o.cor; document.getElementById('title-otica').innerText = "Editar Ótica"; window.openModal('modal-otica'); };
        window.saveOtica = async () => { const data = { nome: document.getElementById('ot-nome').value, tipo: document.getElementById('ot-tipo').value, valor: parseFloat(document.getElementById('ot-valor').value || 0), cor: document.getElementById('ot-cor').value }; if(editOId) await updateDoc(doc(db, "oticas", editOId), data); else await addDoc(collection(db, "oticas"), data); window.closeModal('modal-otica'); };
        
        window.editTemplate = (id) => {
            const t = templates.find(i => i.id === id);
            editTId = id;
            document.getElementById('t-titulo').value = t.titulo;
            document.getElementById('t-texto').value = t.texto;
            document.getElementById('title-template').innerText = "Editar Template";
            window.openModal('modal-template');
        };

        window.saveTemplate = async () => { const data = { titulo: document.getElementById('t-titulo').value, texto: document.getElementById('t-texto').value }; if(editTId) await updateDoc(doc(db, "templates", editTId), data); else await addDoc(collection(db, "templates"), { ...data, created: Date.now() }); window.closeModal('modal-template'); };
        
        window.openDisparo = (id) => { 
            const p = pacientes.find(i => i.id === id); 
            document.getElementById('target-name').innerText = p.nome; 
            const list = document.getElementById('pick-list'); list.innerHTML = ""; 
            templates.forEach(t => { 
                const btn = document.createElement('button'); 
                btn.className = "w-full p-4 bg-white/5 rounded-2xl hover:bg-medical/10 text-left font-bold text-sm border border-white/5 text-white"; 
                btn.innerText = t.titulo; 
                btn.onclick = () => window.open(`https://wa.me/55${p.tel.replace(/\D/g,'')}?text=${encodeURIComponent(t.texto.replace(/{{nome}}/g, p.nome).replace(/{{otica}}/g, p.oticaNome || "Particular"))}`, "_blank"); 
                list.appendChild(btn); 
            }); 
            window.openModal('modal-pick'); 
        };

        window.apagar = async (col, id) => { if(confirm("Confirmar exclusão?")) { await deleteDoc(doc(db, col, id)); if(col === 'historicos') renderHistoricoCompleto(); } };
        window.changeStatus = async (id, val) => { await updateDoc(doc(db, "pacientes", id), { status: val }); };
        window.togglePago = async (id, current) => { await updateDoc(doc(db, "pacientes", id), { pago: !current }); };
        
        lucide.createIcons();
    </script>
</body>
</html>